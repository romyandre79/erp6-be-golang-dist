import{b2 as d}from"./DirAx5lA.js";import{u as l}from"./CoedoqIK.js";import{bm as a,u}from"#entry";const m=d("notification",{state:()=>({notifications:[],ws:null,connected:!1,reconnectInterval:1e3}),getters:{unreadCount:t=>t.notifications.filter(o=>o.isread===0).length},actions:{async fetchUnread(){const{data:t}=await a("/api/admin/notifications/unread","$2dHEnwL9Wl");t.value&&t.value.status==="success"&&(this.notifications=t.value.data||[])},async markAsRead(t){await a(`/api/admin/notifications/${t}/read`,{method:"POST"},"$RicZWHqi3K");const o=this.notifications.find(s=>s.usertodoid===t);o&&(o.isread=1)},async connect(){const o=l().token||localStorage.getItem("token");if(!o)return;const i=`${window.location.protocol==="https:"?"wss:":"ws:"}//localhost:8888/ws/notifications?token=${o}`;console.log("Connecting WS:",i),this.ws=new WebSocket(i),this.ws.onopen=()=>{console.log("WS Connected"),this.connected=!0},this.ws.onmessage=e=>{try{const n=JSON.parse(e.data);if(n.type==="notification"){this.notifications.unshift(n.data);const{$toast:r}=u();r&&r.add({title:n.data.menuname,description:n.data.description})}}catch(n){console.error("WS Parse error",n)}},this.ws.onclose=()=>{this.connected=!1,setTimeout(()=>this.connect(),this.reconnectInterval)},this.ws.onerror=e=>{console.error("WS Error",e),this.ws?.close()}},async sendMessage(t,o,s,c=""){const{data:i,error:e}=await a("/api/admin/notifications/send",{method:"POST",body:{receiverid:t,title:o,message:s,docno:c}},"$RoMatoeq2f");if(e.value)throw e.value;return i.value}}});export{m as u};
