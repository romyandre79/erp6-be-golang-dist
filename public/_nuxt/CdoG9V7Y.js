import{n as se,k as _,e as ie,j as O,q as de,s as Y,x as re,c as b,a as o,m as F,h as B,F as T,r as $,t as w,l as k,v as j,y as ce,z as ue,o as f,A as pe,_ as me}from"#entry";import{u as be}from"./CsY25JMR.js";import"./dYBcFXXL.js";const fe=se("dbobject",()=>{const A=_([]),g=_({dbobjectid:"",objectname:"",dbobjecttypeid:"",objectcontent:"",objectversion:"",ispublished:0,comment:""}),x=_(!1),i=be();async function u(){x.value=!0;try{let d=new FormData;d.append("flowname","searchcombodbobjecttype"),d.append("menu","admin"),d.append("search","true");let l=await i.post("/admin/execute-flow",d);A.value=l?.data?.data??{},d=new FormData,d.append("flowname","searchdbobject"),d.append("menu","admin"),d.append("search","true"),l=await i.post("/admin/execute-flow",d),A.value=l?.data?.data??{}}finally{x.value=!1}}async function S(d){x.value=!0;try{const l=new FormData;l.append("flowname","getdbobject"),l.append("menu","admin"),l.append("search","true"),l.append("dbobjectid",d);const D=await i.post("/admin/execute-flow",l);g.value=D?.data?.data??{}}finally{x.value=!1}}async function N(d){try{const l=new FormData;l.append("flowname","modifdbobject"),l.append("menu","admin"),l.append("search","true"),l.append("dbobjectid",d.dbobjectid),l.append("objectname",d.objectname),l.append("dbobjecttypeid",d.dbobjecttypeid),l.append("objectcontent",d.objectcontent),l.append("ispublished",d.ispublished),l.append("comment",d.comment),await i.post("/admin/execute-flow",l)}finally{x.value=!1}}async function R(d){try{const l=new FormData;l.append("flowname","purgedbobject"),l.append("menu","admin"),l.append("search","true"),l.append("dbobjectid",d),await i.post("/admin/execute-flow",l)}finally{x.value=!1}}return{fetchAll:u,fetch:S,saveTable:N,purgeTable:R,dbobject:g,dbobjects:A,loading:x}}),ve={class:"h-screen flex flex-col bg-gray-50"},ye={class:"flex flex-1 overflow-hidden"},xe={class:"absolute inset-0 pointer-events-none",style:{overflow:"visible"}},he=["d"],ge=["d"],we=["onDragstart","onDblclick","data-table-id"],ke={class:"flex items-center justify-between p-2 bg-gray-800 text-white rounded-t"},_e={class:"font-medium"},je={class:"flex gap-1"},Ce=["onClick"],Ne=["onClick"],De={class:"p-2 text-xs"},Se=["data-col-index"],Re={class:"w-6 text-gray-600"},Te={class:"flex-1 truncate"},$e={class:"text-gray-500 text-[11px]"},Ae=["onPointerdown"],Fe={class:"w-96 border-l bg-white p-4 overflow-auto"},Oe={key:0,class:"space-y-4"},Ve={class:"text-lg font-semibold"},Je={class:"flex gap-2 mt-1"},Pe={class:"mt-2 space-y-2"},Ue=["onUpdate:modelValue"],Ye=["onUpdate:modelValue"],Be=["onClick"],Ee={class:"flex gap-2"},Le={class:"mt-4"},Me={key:0},Xe={class:"text-sm"},Ie={class:"flex gap-2"},qe=["onClick"],ze=["onClick"],He={key:1,class:"text-gray-400 text-sm"},We=ie({__name:"dbobject",setup(A){let g=1,x=1;const i=O([]),u=O([]),S=_(null),N=_(null),R=_({x:0,y:0}),d=_(null),l=_(""),D=fe(),h=_({dbobjectid:"",objectname:"",dbobjecttypeid:"",objectcontent:"",objectversion:"",ispublished:0,comment:""}),m=O({active:!1,from:null,sx:0,sy:0,path:""});function E(n=40,e=40){const t={id:g++,dbid:"",name:`table_${g}`,x:n,y:e,width:240,columns:[{name:"id",type:"int"},{name:"name",type:"varchar"}]};i.push(t)}function L(){const a=i.length,r=Math.floor(a/4),v=a%4;E(40+v*340,40+r*200)}function M(n,e){const v=Math.floor(e/4),y=e%4;let c=[{name:"id",type:"int"},{name:"name",type:"varchar"}];if(n.objectcontent)try{const p=JSON.parse(n.objectcontent);Array.isArray(p.columns)&&(c=p.columns.map(U=>({name:U.name||"col",type:U.type||"varchar"})))}catch{console.warn(`Invalid objectcontent JSON for ${n.objectname}`)}return{id:Number(n.dbobjectid)||g++,dbid:Number(n.dbobjectid),name:n.objectname||`table_${e+1}`,x:40+y*340,y:40+v*200,width:240,columns:c,ispublished:n.ispublished==1,comment:n.comment}}function X(n){S.value=n;const e=i.find(t=>t.id===n);l.value=e?JSON.stringify(e,null,2):""}const s=de(()=>i.find(n=>n.id===S.value)||null);function I(n,e){N.value=n.id;const t=e.target.getBoundingClientRect();R.value={x:e.clientX-t.left,y:e.clientY-t.top}}function q(n){const e=d.value.getBoundingClientRect();if(!N.value)return;const t=i.find(a=>a.id===N.value);t&&(t.x=n.clientX-e.left-R.value.x,t.y=n.clientY-e.top-R.value.y,N.value=null,C())}async function z(n){if(!confirm("Are you sure ?"))return;const e=i.findIndex(a=>a.id===n),t=i.find(a=>a.id===n);console.log(t),await D.purgeTable(t.dbid),e>=0&&i.splice(e,1);for(let a=u.length-1;a>=0;a--)(u[a].from.table===n||u[a].to.table===n)&&u.splice(a,1)}function H(n){const e=JSON.parse(JSON.stringify(n));e.id=g++,e.x+=20,e.y+=20,e.name=n.name+"_copy",i.push(e),C()}function W(){s.value&&s.value.columns.push({name:"new_col",type:"varchar"})}function G(n){s.value&&s.value.columns.splice(n,1)}function K(){s.value&&(s.value.columns.forEach(n=>{const e=(n.name||"").toLowerCase();e.includes("id")?n.type="int":e.includes("date")||e.includes("at")?n.type="datetime":e.startsWith("is_")||e.startsWith("is")?n.type="boolean":n.type=n.type||"varchar"}),l.value=JSON.stringify(s.value,null,2))}function Q(){if(s.value)try{const n=JSON.parse(l.value);s.value.name=n.name||s.value.name,s.value.x=Number(n.x??s.value.x),s.value.y=Number(n.y??s.value.y),s.value.width=Number(n.width??s.value.width),Array.isArray(n.columns)&&(s.value.columns=n.columns),C(),alert("Applied to selected table")}catch{alert("Invalid JSON")}}function Z(){navigator.clipboard.writeText(l.value).then(()=>alert("Copied"))}async function ee(){confirm("Reset design?")&&await V()}async function V(){i.splice(0,i.length),u.splice(0,u.length),g=1,x=1,S.value=null,await D.fetchAll(),i.splice(0,i.length),u.splice(0,u.length),D.dbobjects.forEach((n,e)=>{const t=M(n,e);i.push(t)}),g=Math.max(...i.map(n=>n.id),0)+1,C()}function te(n,e,t){const a=d.value.getBoundingClientRect(),r=i.find(p=>p.id===n);if(!r)return;const v=r.y+36+e*24;m.active=!0,m.from={table:n,col:e},m.sx=r.x+r.width,m.sy=v,J(t.clientX-a.left,t.clientY-a.top);const y=p=>J(p.clientX-a.left,p.clientY-a.top),c=p=>ne(p,y,c);window.addEventListener("pointermove",y),window.addEventListener("pointerup",c)}function J(n,e){m.path=P(m.sx,m.sy,n,e)}function ne(n,e,t){if(window.removeEventListener("pointermove",e),window.removeEventListener("pointerup",t),!m.active)return;const a=d.value.getBoundingClientRect(),r=n.clientX-a.left,v=n.clientY-a.top;let y=null;for(const c of i)if(r>=c.x&&r<=c.x+c.width&&v>=c.y&&v<=c.y+200){const p=Math.floor((v-(c.y+36))/24);if(p>=0&&p<c.columns.length){y={table:c.id,col:p};break}}if(y){const c={id:x++,from:{table:m.from.table,col:m.from.col,colName:i.find(p=>p.id===m.from.table).columns[m.from.col].name},to:{table:y.table,col:y.col,colName:i.find(p=>p.id===y.table).columns[y.col].name},path:""};u.push(c),C()}m.active=!1,m.path=""}function P(n,e,t,a){const r=(n+t)/2;return`M ${n} ${e} C ${r} ${e} ${r} ${a} ${t} ${a}`}function C(){u.forEach(n=>{const e=i.find(c=>c.id===n.from.table),t=i.find(c=>c.id===n.to.table);if(!e||!t)return;const a=e.y+36+n.from.col*24,r=e.x+e.width,v=t.y+36+n.to.col*24,y=t.x;n.path=P(r,a,y,v)})}function oe(n){const e=u.findIndex(t=>t.id===n);e>=0&&u.splice(e,1)}function ae(n){alert("Edit relation not implemented yet")}Y(i,C,{deep:!0}),Y(u,C,{deep:!0});async function le(){if(!i.length)return alert("No tables to save");try{for(const n of ue(i)){h.value={dbobjectid:"",objectname:"",dbobjecttypeid:"",objectcontent:"",objectversion:"",ispublished:0,comment:""},h.value.dbobjectid=n.dbid||"",h.value.objectname=n.name,h.value.dbobjecttypeid=1;const e={table:n,relations:u.filter(t=>t.from.table===n.id||t.to.table===n.id).map(t=>({id:t.id,from:t.from,to:t.to}))};h.value.objectcontent=JSON.stringify(e),h.value.objectversion="1",h.value.ispublished=n.ispublished==!0?1:0,h.value.comment=n.comment||"",console.log(h.value),await D.saveTable(h.value),console.log(`Saved table ${n.name}`)}alert("All tables saved successfully")}catch(n){console.error(n),alert("Failed to save some tables")}}return re(async()=>{await V()}),(n,e)=>(f(),b("div",ve,[o("header",{class:"flex items-center justify-between p-4 border-b bg-white"},[e[10]||(e[10]=o("div",{class:"flex items-center gap-3"},[o("h1",{class:"text-xl font-semibold"},"Database Designer")],-1)),o("div",{class:"flex items-center gap-2"},[o("button",{onClick:L,class:"px-3 py-2 rounded bg-green-600 text-white"},"Add Table"),o("button",{onClick:le,class:"px-3 py-1 rounded bg-green-600 text-white"},"Save"),o("button",{onClick:ee,class:"px-3 py-1 rounded bg-red-500 text-white"},"Reset")])]),o("div",ye,[o("div",{class:"flex-1 relative p-4 bg-gray-100",onDragover:e[0]||(e[0]=F(()=>{},["prevent"])),onDrop:q,ref_key:"canvasRef",ref:d},[(f(),b("svg",xe,[e[11]||(e[11]=o("defs",null,[o("marker",{id:"arrow",markerWidth:"10",markerHeight:"10",refX:"10",refY:"5",orient:"auto"},[o("path",{d:"M0,0 L10,5 L0,10 z",fill:"black"})])],-1)),(f(!0),b(T,null,$(u,t=>(f(),b("g",{key:t.id},[o("path",{d:t.path,stroke:"black","stroke-width":"2",fill:"none","marker-end":"url(#arrow)"},null,8,he)]))),128)),m.active?(f(),b("path",{key:0,d:m.path,stroke:"gray","stroke-width":"2",fill:"none","stroke-dasharray":"6 4"},null,8,ge)):B("",!0)])),(f(!0),b(T,null,$(i,t=>(f(),b("div",{key:t.id,class:"absolute shadow-lg rounded border bg-white cursor-move",style:pe({left:t.x+"px",top:t.y+"px",width:t.width+"px"}),draggable:"true",onDragstart:a=>I(t,a),onDblclick:a=>X(t.id),"data-table-id":t.id},[o("div",ke,[o("div",_e,w(t.name||"table_"+t.id),1),o("div",je,[o("button",{onClick:F(a=>H(t),["stop"]),title:"Duplicate",class:"text-xs px-2"},"⧉",8,Ce),o("button",{onClick:F(a=>z(t.id),["stop"]),title:"Delete",class:"text-xs px-2"},"✕",8,Ne)])]),o("div",De,[(f(!0),b(T,null,$(t.columns,(a,r)=>(f(),b("div",{key:r,class:"flex items-center gap-2","data-col-index":r},[o("span",Re,w(r+1),1),o("span",Te,w(a.name),1),o("span",$e,w(a.type||""),1),o("button",{onPointerdown:F(v=>te(t.id,r,v),["stop","prevent"]),class:"w-4 h-4 rounded-full bg-blue-500",title:"Start relation"},null,40,Ae)],8,Se))),128))])],44,we))),128)),e[12]||(e[12]=o("div",{class:"absolute left-4 bottom-4"},null,-1))],544),o("aside",Fe,[s.value?(f(),b("div",Oe,[o("h2",Ve,"Properties — "+w(s.value.name||"Untitled"),1),o("div",null,[e[13]||(e[13]=o("label",{class:"text-sm text-gray-600"},"Table Name",-1)),k(o("input",{"onUpdate:modelValue":e[1]||(e[1]=t=>s.value.name=t),class:"w-full mt-1 p-2 border rounded"},null,512),[[j,s.value.name]])]),o("div",null,[e[14]||(e[14]=o("label",{class:"text-sm text-gray-600"},"Comment",-1)),k(o("input",{"onUpdate:modelValue":e[2]||(e[2]=t=>s.value.comment=t),class:"w-full mt-1 p-2 border rounded"},null,512),[[j,s.value.comment]])]),o("div",null,[e[15]||(e[15]=o("label",{class:"text-sm text-gray-600"},"Is Published",-1)),k(o("input",{type:"checkbox","onUpdate:modelValue":e[3]||(e[3]=t=>s.value.ispublished=t),class:"w-full mt-1 p-2 border rounded"},null,512),[[ce,s.value.ispublished]])]),o("div",null,[e[16]||(e[16]=o("label",{class:"text-sm text-gray-600"},"Position",-1)),o("div",Je,[k(o("input",{type:"number","onUpdate:modelValue":e[4]||(e[4]=t=>s.value.x=t),class:"w-1/3 p-2 border rounded"},null,512),[[j,s.value.x,void 0,{number:!0}]]),k(o("input",{type:"number","onUpdate:modelValue":e[5]||(e[5]=t=>s.value.y=t),class:"w-1/3 p-2 border rounded"},null,512),[[j,s.value.y,void 0,{number:!0}]]),k(o("input",{type:"number","onUpdate:modelValue":e[6]||(e[6]=t=>s.value.width=t),class:"w-1/3 p-2 border rounded"},null,512),[[j,s.value.width,void 0,{number:!0}]])])]),o("div",null,[e[17]||(e[17]=o("label",{class:"text-sm text-gray-600"},"Columns",-1)),o("div",Pe,[(f(!0),b(T,null,$(s.value.columns,(t,a)=>(f(),b("div",{key:a,class:"flex items-center gap-2"},[k(o("input",{"onUpdate:modelValue":r=>t.name=r,placeholder:"name",class:"flex-1 p-2 border rounded"},null,8,Ue),[[j,t.name]]),k(o("input",{"onUpdate:modelValue":r=>t.type=r,placeholder:"type",class:"w-36 p-2 border rounded"},null,8,Ye),[[j,t.type]]),o("button",{onClick:r=>G(a),class:"px-2 py-1 bg-red-500 text-white rounded"},"-",8,Be)]))),128)),o("div",Ee,[o("button",{onClick:e[7]||(e[7]=t=>W()),class:"px-3 py-1 bg-blue-600 text-white rounded"},"Add Column"),o("button",{onClick:e[8]||(e[8]=t=>K()),class:"px-3 py-1 bg-gray-200 rounded"},"Auto Types")])])]),o("div",null,[e[18]||(e[18]=o("label",{class:"text-sm text-gray-600"},"Raw JSON",-1)),k(o("textarea",{"onUpdate:modelValue":e[9]||(e[9]=t=>l.value=t),rows:"6",class:"w-full p-2 border rounded mt-1 text-xs font-mono"},null,512),[[j,l.value]]),o("div",{class:"flex gap-2 mt-2"},[o("button",{onClick:Q,class:"px-3 py-1 bg-green-600 text-white rounded"},"Apply"),o("button",{onClick:Z,class:"px-3 py-1 bg-indigo-600 text-white rounded"},"Copy")])])])):B("",!0),o("div",Le,[e[19]||(e[19]=o("h3",{class:"font-semibold"},"Relations",-1)),u.length?(f(),b("div",Me,[(f(!0),b(T,null,$(u,t=>(f(),b("div",{key:t.id,class:"flex items-center justify-between mt-2"},[o("div",Xe,w(t.from.table)+"."+w(t.from.col)+" ➜ "+w(t.to.table)+"."+w(t.to.col??"-"),1),o("div",Ie,[o("button",{onClick:a=>ae(t.id),class:"px-2 py-1 bg-gray-200 rounded"},"Edit",8,qe),o("button",{onClick:a=>oe(t.id),class:"px-2 py-1 bg-red-500 text-white rounded"},"Delete",8,ze)])]))),128))])):(f(),b("div",He,"No relations"))])])])]))}}),Ze=me(We,[["__scopeId","data-v-ae5cdee2"]]);export{Ze as default};
