import{n as ke,k as w,e as _e,j as L,q as je,s as I,x as Ce,c as b,a as l,m as D,F as T,r as E,h as z,t as j,l as h,v as C,y as q,z as Ae,o as v,A as H,B as Se,C as Ne}from"#entry";import{u as De}from"./BKu5god-.js";import"./BJZKwT5v.js";import{u as Te}from"./sbBiWOa1.js";import"./VUwJYlGX.js";const Ee=ke("dbobject",()=>{const R=w([]),k=w({dbobjectid:"",objectname:"",dbobjecttypeid:"",objectcontent:"",objectversion:"",ispublished:0,comment:""}),g=w(!1),r=De();async function f(){g.value=!0;try{let u=new FormData;u.append("flowname","searchcombodbobjecttype"),u.append("menu","admin"),u.append("search","true");let s=await r.post("/admin/execute-flow",u);R.value=s?.data?.data??{},u=new FormData,u.append("flowname","searchdbobject"),u.append("menu","admin"),u.append("search","true"),s=await r.post("/admin/execute-flow",u),R.value=s?.data?.data??{}}finally{g.value=!1}}async function V(u){g.value=!0;try{const s=new FormData;s.append("flowname","getdbobject"),s.append("menu","admin"),s.append("search","true"),s.append("dbobjectid",u);const _=await r.post("/admin/execute-flow",s);k.value=_?.data?.data??{}}finally{g.value=!1}}async function x(u){try{const s=new FormData;s.append("flowname","modifdbobject"),s.append("menu","admin"),s.append("search","true"),s.append("dbobjectid",u.dbobjectid),s.append("objectname",u.objectname),s.append("dbobjecttypeid",u.dbobjecttypeid),s.append("objectcontent",u.objectcontent),s.append("ispublished",u.ispublished),s.append("comment",u.comment),await r.post("/admin/execute-flow",s)}finally{g.value=!1}}async function S(u){try{const s=new FormData;s.append("flowname","purgedbobject"),s.append("menu","admin"),s.append("search","true"),s.append("dbobjectid",u),await r.post("/admin/execute-flow",s)}finally{g.value=!1}}return{fetchAll:f,fetch:V,saveTable:x,purgeTable:S,dbobject:k,dbobjects:R,loading:g}}),Re={class:"h-screen flex flex-col bg-gray-50"},Ve={class:"flex flex-1 overflow-hidden"},$e=["data-area-id","onMousedown"],Me={class:"bg-purple-600 text-white text-xs px-2 py-1 rounded-t-xl cursor-move flex items-center justify-between"},Ue=["onUpdate:modelValue"],Le=["onClick"],Oe=["onMousedown"],Fe={class:"absolute inset-0 pointer-events-none",style:{overflow:"visible"}},Ye=["d"],Xe=["d"],Je=["onDragstart","onDblclick","data-table-id"],Be={class:"flex items-center justify-between p-2 bg-gray-800 text-white rounded-t"},Pe={class:"font-medium"},Ie={class:"flex gap-1"},ze=["onClick"],qe=["onClick"],He={class:"p-2 text-xs"},We=["data-col-index"],Ge={class:"w-6 text-gray-600"},Ke={class:"flex-1 truncate"},Qe={class:"text-gray-500 text-[11px]"},Ze=["onPointerdown"],et={class:"w-96 border-l bg-white p-4 overflow-auto"},tt={key:0,class:"space-y-4"},ot={class:"text-lg font-semibold"},nt={class:"flex gap-2 mt-1"},lt={class:"mt-2 space-y-2"},at=["onUpdate:modelValue"],st=["onUpdate:modelValue"],it=["onUpdate:modelValue"],dt=["onUpdate:modelValue"],rt=["onClick"],ct={class:"flex gap-2"},ut={class:"mt-4"},pt={key:0},mt={class:"text-sm"},ft={class:"flex gap-2"},bt=["onClick"],vt=["onClick"],yt={key:1,class:"text-gray-400 text-sm"},_t=_e({__name:"dbobject",setup(R){let k=1,g=1;const r=L([]),f=L([]),V=Te(),x=L([]);let S=1;const u=w(null),s=w(null),_=w({x:0,y:0}),O=w(null),$=w(null),F=w({x:0,y:0}),M=w(null),N=w(""),U=Ee();w({dbobjectid:"",objectname:"",dbobjecttypeid:"",objectcontent:"",objectversion:"",ispublished:0,comment:""});const y=L({active:!1,from:null,sx:0,sy:0,path:""});function W(t=40,e=40){const o={id:k++,dbid:"",name:`table_${k}`,x:t,y:e,width:240,columns:[{name:"id",type:"auto"},{name:"name",type:"text"}]};r.push(o)}function G(){const n=r.length,a=Math.floor(n/4),m=n%4;W(40+m*340,40+a*200)}function K(t,e){let o=0,n=0,a=120,m=[];if(t.objectcontent)try{const d=JSON.parse(t.objectcontent);d?.table?.columns&&Array.isArray(d.table.columns)&&(m=d.table.columns.map(c=>({name:c.name||"col",type:c.type||"text",allownull:c.allownull??!1,default:c.default??""}))),o=d?.table?.x??40+e%4*340,n=d?.table?.y??40+Math.floor(e/4)*200,a=d?.table?.width??240,d.areas&&d.areas.length>0&&d.areas.forEach(c=>{x.find(ge=>ge.id==c.id)==null&&Q(c)})}catch(d){console.warn(`Invalid objectcontent JSON for ${t.objectname}`,d)}return{id:k++,dbid:t.dbobjectid??"",name:t.objectname||`table_${e+1}`,x:o,y:n,width:a,columns:m,ispublished:t.ispublished==1,comment:t.comment??""}}function Q(t){console.log("data ",t);const e={id:t.id,name:t.name,x:t.x,y:t.y,width:t.width,height:t.height,color:t.color,type:"area"};x.push(e),console.log("areas ",x),Z(e)}function Z(t){const e=document.createElement("div");e.className="design-area",e.style.left=t.x+"px",e.style.top=t.y+"px",e.style.width=t.width+"px",e.style.height=t.height+"px",e.style.background=t.color||"#fef9c3",e.dataset.id=t.id,e.dataset.type="area",makeAreaDraggableAndResizable(e,t)}function ee(t){O.value=t;const e=r.find(o=>o.id===t);N.value=e?JSON.stringify(e,null,2):""}const i=je(()=>r.find(t=>t.id===O.value)||null);function te(t,e){$.value=t.id;const o=e.target.getBoundingClientRect();F.value={x:e.clientX-o.left,y:e.clientY-o.top}}function oe(t){const e=M.value.getBoundingClientRect();if(!$.value)return;const o=r.find(n=>n.id===$.value);o&&(o.x=t.clientX-e.left-F.value.x,o.y=t.clientY-e.top-F.value.y,$.value=null,A())}async function ne(t){if(!confirm("Are you sure to delete Area ?"))return;const e=x.findIndex(o=>o.id===t);e>=0&&x.splice(e,1)}async function le(t){if(!confirm("Are you sure to delete Table?"))return;const e=r.findIndex(n=>n.id===t),o=r.find(n=>n.id===t);o.dbid&&await U.purgeTable(o.dbid),e>=0&&r.splice(e,1);for(let n=f.length-1;n>=0;n--)(f[n].from.table===t||f[n].to.table===t)&&f.splice(n,1)}function ae(t){const e=JSON.parse(JSON.stringify(t));e.id=k++,e.dbid="",e.x+=20,e.y+=20,e.name=t.name+"_copy",r.push(e),A()}function se(){i.value&&i.value.columns.push({name:"new_col",type:"varchar"})}function ie(t){i.value&&i.value.columns.splice(t,1)}function de(){i.value&&(i.value.columns.forEach(t=>{const e=(t.name||"").toLowerCase();e.includes("id")?t.type="int":e.includes("date")||e.includes("at")?t.type="datetime":e.startsWith("is_")||e.startsWith("is")?t.type="boolean":t.type=t.type||"varchar"}),N.value=JSON.stringify(i.value,null,2))}function re(){if(i.value)try{const t=JSON.parse(N.value);i.value.name=t.name||i.value.name,i.value.x=Number(t.x??i.value.x),i.value.y=Number(t.y??i.value.y),i.value.width=Number(t.width??i.value.width),Array.isArray(t.columns)&&(i.value.columns=t.columns),A(),alert("Applied to selected table")}catch{alert("Invalid JSON")}}function ce(){navigator.clipboard.writeText(N.value).then(()=>alert("Copied"))}async function ue(){confirm("Reset design?")&&await J()}function pe(t,e){f.splice(0,f.length),console.log(t),t.forEach(o=>{if(!o.objectcontent)return;let n;try{n=JSON.parse(o.objectcontent)}catch{return}!n.relations||!Array.isArray(n.relations)||(console.log("rel ",n.relations),n.relations.forEach(a=>{const m=e[a.from.table],p=e[a.to.table];!m||!p||f.some(c=>c.from.table===m&&c.from.col===a.from.col&&c.to.table===p&&c.to.col===a.to.col)||f.push({id:g++,from:{table:m,col:a.from.col,colName:a.from.colName},to:{table:p,col:a.to.col,colName:a.to.colName},path:""})}))}),A()}async function J(){r.splice(0,r.length),f.splice(0,f.length),x.splice(0,x.length),k=1,g=1,O.value=null,await U.fetchAll();const t=new Set,e=[],o={};(U.dbobjects||[]).forEach(n=>{const a=n?.dbobjectid?String(n.dbobjectid):n?.objectname??"";a&&(t.has(a)?console.debug("Skipping duplicate dbobject from store:",a):(t.add(a),e.push(n)))}),e.forEach((n,a)=>{const m=K(n,a);o[n.dbobjectid]=m.id,r.push(m)}),k=Math.max(...r.map(n=>n.id),0)+1,pe(e,o),A()}function me(t,e,o){const n=M.value.getBoundingClientRect(),a=r.find(c=>c.id===t);if(!a)return;const m=a.y+36+e*24;y.active=!0,y.from={table:t,col:e},y.sx=a.x+a.width,y.sy=m,B(o.clientX-n.left,o.clientY-n.top);const p=c=>B(c.clientX-n.left,c.clientY-n.top),d=c=>fe(c,p,d);window.addEventListener("pointermove",p),window.addEventListener("pointerup",d)}function B(t,e){y.path=P(y.sx,y.sy,t,e)}function fe(t,e,o){if(window.removeEventListener("pointermove",e),window.removeEventListener("pointerup",o),!y.active)return;const n=M.value.getBoundingClientRect(),a=t.clientX-n.left,m=t.clientY-n.top;let p=null;for(const d of r)if(a>=d.x&&a<=d.x+d.width&&m>=d.y&&m<=d.y+200){const c=Math.floor((m-(d.y+36))/24);if(c>=0&&c<d.columns.length){p={table:d.id,col:c};break}}if(p){const d={id:g++,from:{table:y.from.table,col:y.from.col,colName:r.find(c=>c.id===y.from.table).columns[y.from.col].name},to:{table:p.table,col:p.col,colName:r.find(c=>c.id===p.table).columns[p.col].name},path:""};f.push(d),A()}y.active=!1,y.path=""}function P(t,e,o,n){const a=(t+o)/2;return`M ${t} ${e} C ${a} ${e} ${a} ${n} ${o} ${n}`}function A(){f.forEach(t=>{const e=r.find(d=>d.id===t.from.table),o=r.find(d=>d.id===t.to.table);if(!e||!o)return;const n=e.y+36+t.from.col*24,a=e.x+e.width,m=o.y+36+t.to.col*24,p=o.x;t.path=P(a,n,p,m)})}function be(t){const e=f.findIndex(o=>o.id===t);e>=0&&f.splice(e,1)}function ve(t){alert("Edit relation not implemented yet")}I(r,A,{deep:!0}),I(f,A,{deep:!0});async function ye(){if(!r.length)return alert("No tables to save");try{for(const t of Ae(r)){const e={table:t,relations:f.filter(p=>p.from.table===t.id||p.to.table===t.id).map(p=>({id:p.id,from:p.from,to:p.to})),areas:x};console.log("payload ",e);const o={dbobjectid:t.dbid?String(t.dbid):"",objectname:t.name,dbobjecttypeid:"1",objectcontent:JSON.stringify(e),objectversion:"1",ispublished:t.ispublished?1:0,comment:t.comment||""},n=await U.saveTable(o),a=n?.data?.data??n,m=a?.dbobjectid??a?.dbobjectid??null;if(m){const p=r.find(d=>d.id===t.id);p&&(p.dbid=m)}}V.add({title:"Success",description:"Runtime schema saved successfully",color:"success"})}catch(t){console.error(t),V.add({title:"Error",description:String(t),color:"error"})}}Ce(async()=>{await J()});function xe(){S=S+1,x.push({id:S,name:"Area "+S,x:100,y:100,width:400,height:300,color:"#e3e9ff"}),console.log("push area ",x)}function he(t,e){u.value=t,s.value="move",_.value={x:e.clientX-t.x,y:e.clientY-t.y},window.addEventListener("mousemove",Y),window.addEventListener("mouseup",X)}function we(t,e){u.value=t,s.value="resize",_.value={x:e.clientX,y:e.clientY},window.addEventListener("mousemove",Y),window.addEventListener("mouseup",X)}function Y(t){if(!u.value)return;const e=u.value;if(s.value==="move"&&(e.x=t.clientX-_.value.x,e.y=t.clientY-_.value.y),s.value==="resize"){const o=t.clientX-_.value.x,n=t.clientY-_.value.y;e.width+=o,e.height+=n,_.value={x:t.clientX,y:t.clientY}}}function X(){u.value=null,s.value=null,window.removeEventListener("mousemove",Y),window.removeEventListener("mouseup",X)}return(t,e)=>(v(),b("div",Re,[l("header",{class:"flex items-center justify-between p-4 border-b bg-white"},[e[10]||(e[10]=l("div",{class:"flex items-center gap-3"},[l("h1",{class:"text-xl font-semibold"},"Database Designer")],-1)),l("div",{class:"flex items-center gap-2"},[l("button",{onClick:G,class:"px-3 py-2 rounded bg-green-600 text-white"},"Add Table"),l("button",{onClick:xe,class:"px-3 py-2 rounded bg-purple-600 text-white"},"Add Area"),l("button",{onClick:ye,class:"px-3 py-1 rounded bg-green-600 text-white"},"Save"),l("button",{onClick:ue,class:"px-3 py-1 rounded bg-red-500 text-white"},"Reset")])]),l("div",Ve,[l("div",{class:"flex-1 relative p-4 bg-gray-100",onDragover:e[0]||(e[0]=D(()=>{},["prevent"])),onDrop:oe,ref_key:"canvasRef",ref:M,id:"drawflow"},[(v(!0),b(T,null,E(x,o=>(v(),b("div",{key:o.id,"data-area-id":o.id,class:"absolute rounded-xl border border-purple-400 bg-purple-200/30",style:H({left:o.x+"px",top:o.y+"px",width:o.width+"px",height:o.height+"px"}),onMousedown:n=>he(o,n)},[l("div",Me,[h(l("input",{"onUpdate:modelValue":n=>o.name=n,class:"bg-purple-600 outline-none flex-1 rounded px-2"},null,8,Ue),[[C,o.name]]),l("button",{onClick:D(n=>ne(o.id),["stop"]),class:"ml-2 text-white hover:text-red-300 font-bold",title:"Delete Area"}," ✕ ",8,Le)]),l("div",{class:"absolute bottom-0 right-0 w-4 h-4 bg-purple-600 cursor-se-resize rounded",onMousedown:D(n=>we(o,n),["stop"])},null,40,Oe)],44,$e))),128)),(v(),b("svg",Fe,[e[11]||(e[11]=l("defs",null,[l("marker",{id:"arrow",markerWidth:"10",markerHeight:"10",refX:"10",refY:"5",orient:"auto"},[l("path",{d:"M0,0 L10,5 L0,10 z",fill:"black"})])],-1)),(v(!0),b(T,null,E(f,o=>(v(),b("g",{key:o.id},[l("path",{d:o.path,stroke:"black","stroke-width":"2",fill:"none","marker-end":"url(#arrow)"},null,8,Ye)]))),128)),y.active?(v(),b("path",{key:0,d:y.path,stroke:"gray","stroke-width":"2",fill:"none","stroke-dasharray":"6 4"},null,8,Xe)):z("",!0)])),(v(!0),b(T,null,E(r,o=>(v(),b("div",{key:o.id,class:"absolute shadow-lg rounded border bg-white cursor-move",style:H({left:o.x+"px",top:o.y+"px",width:o.width+"px"}),draggable:"true",onDragstart:n=>te(o,n),onDblclick:n=>ee(o.id),"data-table-id":o.id},[l("div",Be,[l("div",Pe,j(o.name||"table_"+o.id),1),l("div",Ie,[l("button",{onClick:D(n=>ae(o),["stop"]),title:"Duplicate",class:"text-xs px-2"},"⧉",8,ze),l("button",{onClick:D(n=>le(o.id),["stop"]),title:"Delete",class:"text-xs px-2"},"✕",8,qe)])]),l("div",He,[(v(!0),b(T,null,E(o.columns,(n,a)=>(v(),b("div",{key:a,class:"flex items-center gap-2","data-col-index":a},[l("span",Ge,j(a+1),1),l("span",Ke,j(n.name),1),l("span",Qe,j(n.type||""),1),l("button",{onPointerdown:D(m=>me(o.id,a,m),["stop","prevent"]),class:"w-4 h-4 rounded-full bg-blue-500",title:"Start relation"},null,40,Ze)],8,We))),128))])],44,Je))),128)),e[12]||(e[12]=l("div",{class:"absolute left-4 bottom-4"},null,-1))],544),l("aside",et,[i.value?(v(),b("div",tt,[l("h2",ot,"Properties — "+j(i.value.name||"Untitled"),1),l("div",null,[e[13]||(e[13]=l("label",{class:"text-sm text-gray-600"},"Table Name",-1)),h(l("input",{"onUpdate:modelValue":e[1]||(e[1]=o=>i.value.name=o),class:"w-full mt-1 p-2 border rounded"},null,512),[[C,i.value.name]])]),l("div",null,[e[14]||(e[14]=l("label",{class:"text-sm text-gray-600"},"Comment",-1)),h(l("input",{"onUpdate:modelValue":e[2]||(e[2]=o=>i.value.comment=o),class:"w-full mt-1 p-2 border rounded"},null,512),[[C,i.value.comment]])]),l("div",null,[e[15]||(e[15]=l("label",{class:"text-sm text-gray-600"},"Is Published",-1)),h(l("input",{type:"checkbox","onUpdate:modelValue":e[3]||(e[3]=o=>i.value.ispublished=o),class:"w-full mt-1 p-2 border rounded"},null,512),[[q,i.value.ispublished]])]),l("div",null,[e[16]||(e[16]=l("label",{class:"text-sm text-gray-600"},"Position",-1)),l("div",nt,[h(l("input",{type:"number","onUpdate:modelValue":e[4]||(e[4]=o=>i.value.x=o),class:"w-1/3 p-2 border rounded"},null,512),[[C,i.value.x,void 0,{number:!0}]]),h(l("input",{type:"number","onUpdate:modelValue":e[5]||(e[5]=o=>i.value.y=o),class:"w-1/3 p-2 border rounded"},null,512),[[C,i.value.y,void 0,{number:!0}]]),h(l("input",{type:"number","onUpdate:modelValue":e[6]||(e[6]=o=>i.value.width=o),class:"w-1/3 p-2 border rounded"},null,512),[[C,i.value.width,void 0,{number:!0}]])])]),l("div",null,[e[18]||(e[18]=l("label",{class:"text-sm text-gray-600"},"Columns",-1)),l("div",lt,[(v(!0),b(T,null,E(i.value.columns,(o,n)=>(v(),b("div",{key:n,class:"flex items-center gap-2"},[h(l("input",{"onUpdate:modelValue":a=>o.name=a,placeholder:"name",class:"flex-1 p-2 border rounded"},null,8,at),[[C,o.name]]),h(l("select",{"onUpdate:modelValue":a=>o.type=a,placeholder:"type",class:"w-36 p-2 border rounded"},[...e[17]||(e[17]=[Ne('<option value="auto">Auto Increment</option><option value="text">Text</option><option value="longtext">Long Text</option><option value="number">Number</option><option value="integer">Integer</option><option value="timestamp">Time stamp</option><option value="boolean">Boolean</option>',7)])],8,st),[[Se,o.type]]),h(l("input",{type:"checkbox","onUpdate:modelValue":a=>o.allownull=a,placeholder:"type",class:"w-36 p-2 border rounded"},null,8,it),[[q,o.allownull]]),h(l("input",{"onUpdate:modelValue":a=>o.default=a,placeholder:"default",class:"flex-1 p-2 border rounded"},null,8,dt),[[C,o.default]]),l("button",{onClick:a=>ie(n),class:"px-2 py-1 bg-red-500 text-white rounded"},"-",8,rt)]))),128)),l("div",ct,[l("button",{onClick:e[7]||(e[7]=o=>se()),class:"px-3 py-1 bg-blue-600 text-white rounded"},"Add Column"),l("button",{onClick:e[8]||(e[8]=o=>de()),class:"px-3 py-1 bg-gray-200 rounded"},"Auto Types")])])]),l("div",null,[e[19]||(e[19]=l("label",{class:"text-sm text-gray-600"},"Raw JSON",-1)),h(l("textarea",{"onUpdate:modelValue":e[9]||(e[9]=o=>N.value=o),rows:"6",class:"w-full p-2 border rounded mt-1 text-xs font-mono"},null,512),[[C,N.value]]),l("div",{class:"flex gap-2 mt-2"},[l("button",{onClick:re,class:"px-3 py-1 bg-green-600 text-white rounded"},"Apply"),l("button",{onClick:ce,class:"px-3 py-1 bg-indigo-600 text-white rounded"},"Copy")])])])):z("",!0),l("div",ut,[e[20]||(e[20]=l("h3",{class:"font-semibold"},"Relations",-1)),f.length?(v(),b("div",pt,[(v(!0),b(T,null,E(f,o=>(v(),b("div",{key:o.id,class:"flex items-center justify-between mt-2"},[l("div",mt,j(o.from.table)+"."+j(o.from.col)+" ➜ "+j(o.to.table)+"."+j(o.to.col??"-"),1),l("div",ft,[l("button",{onClick:n=>ve(o.id),class:"px-2 py-1 bg-gray-200 rounded"},"Edit",8,bt),l("button",{onClick:n=>be(o.id),class:"px-2 py-1 bg-red-500 text-white rounded"},"Delete",8,vt)])]))),128))])):(v(),b("div",yt,"No relations"))])])])]))}});export{_t as default};
