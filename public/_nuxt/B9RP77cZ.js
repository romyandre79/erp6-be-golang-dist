import{y as de,a$ as ce,r as c,a as ue,z as pe,w as fe,N as me,B as g,ak as v,an as S,a_ as s,aN as T,ar as we,aF as ge,aM as ve}from"./DH2n3Tqk.js";import{u as xe}from"./CWPKobAF.js";import{t as be}from"./CCayPtYg.js";import{M as ye,u as he,b as ke,e as Ce}from"#entry";import{s as Se}from"./BXI2M5or.js";import{u as Te}from"./C1AnPZyN.js";import"./B3hjldT8.js";import"./KobTAp13.js";/* empty css        */import"./Bu8C_CX3.js";const _e={class:"relative h-full"},Ee={key:0,id:"payload-overlay",class:"absolute top-6 left-6 p-3 bg-white shadow-lg rounded border z-50 max-w-sm"},Re={class:"flex justify-between items-center mb-2"},$e={class:"text-xs whitespace-pre-wrap bg-gray-50 p-2 rounded max-h-40 overflow-auto"},Ne={key:1,class:"absolute inset-0 z-[60] flex items-center justify-center bg-black/50"},ze={class:"bg-white p-6 rounded shadow-xl w-96"},Ie={class:"mb-4"},Pe={key:0,class:"mb-4"},Oe={class:"flex justify-between text-xs mb-1"},Be={class:"w-full bg-gray-200 rounded-full h-2.5"},De={key:1,class:"mb-4 text-red-500 text-sm"},Fe={class:"flex justify-end gap-2"},Ue=["disabled"],Le={class:"absolute right-6 top-6 flex flex-row gap-2 z-50"},Me=de({__name:"Designer",setup(Ae){const{t:D}=ce(),d=xe(),x=Se(),_=c(""),z=c(""),E=c(!1),I=c([]),A=ue(()=>I.value.length>0),P=c(!1),b=c(null),f=c(-1),y=c(""),u=c(""),m=c(!1);let a=null,O=null;function H(o){const{$drawflow:e}=he();if(!e)return console.error("❌ Drawflow plugin not available"),null;const t=new e(o);return t.reroute=!0,t.reroute_fix_curvature=!0,t.force_first_input=!1,t.start(),t.on("nodeCreated",()=>h()),t.on("nodeRemoved",()=>h()),t.on("connectionCreated",()=>h()),t.on("connectionRemoved",()=>h()),t.on("nodeSelected",async n=>{const l=n.replace("node-",""),r=t.drawflow.drawflow?.Home?.data?.[l];r&&(await d.loadComponentProperties(r.name,l.toString()),d.setSelectedNode(r)),oe(l)}),t}function h(){O&&clearTimeout(O),O=setTimeout(()=>{try{d.saveFlow(a.export())}catch(o){console.error("❌ saveFlow error",o)}},500)}async function j(){try{const o=await d.saveFlow(a.export());o.code==200&&x.add({title:D("TITLE UPDATE"),description:D(o.message.replaceAll("_"," "))})}catch(o){console.error("❌ saveFlow error",o)}}function q(o){const e=o.target;e.files&&e.files.length>0&&(b.value=e.files[0],u.value="")}function F(){P.value=!1,b.value=null,f.value=-1,y.value="",u.value="",m.value=!1}async function W(){if(!b.value)return;m.value=!0,f.value=0,y.value="Starting upload...",u.value="";const o=new FormData;o.append("plugin",b.value);try{const e=new XMLHttpRequest;e.upload.addEventListener("progress",r=>{if(r.lengthComputable){const p=Math.round(r.loaded/r.total*100);f.value=p,y.value=`Uploading... ${p}%`}}),e.addEventListener("load",()=>{if(e.status>=200&&e.status<300){f.value=100,y.value="Upload complete! Processing...";try{const r=JSON.parse(e.responseText);x.add({title:"Success",description:"Plugin uploaded successfully",color:"green"}),d.loadComponents(),setTimeout(()=>{F()},1e3)}catch{u.value="Invalid response from server"}}else u.value=`Upload failed: ${e.statusText||"Unknown error"}`;m.value=!1}),e.addEventListener("error",()=>{u.value="Network error during upload",m.value=!1});const n=ke().public.apiBase||"/api";e.open("POST",`${n}/plugins/upload`);const l=Ce("token");l.value&&e.setRequestHeader("Authorization",`Bearer ${l.value}`),e.send(o)}catch(e){console.error("Upload error:",e),u.value=`Exception: ${e}`,m.value=!1}}pe(async()=>{const o=document.getElementById("drawflow");if(!o){console.error("❌ drawflow element not found");return}a=H(o),window.editor=a;const e=d.workflow?.flow;if(e&&a)try{a.import(e),setTimeout(()=>U(),100)}catch(t){console.error("❌ ERROR IMPORT DRAWFLOW",t)}}),fe(()=>d.workflow,o=>{if(!(!o||!o.flow||!a))try{const e=typeof o.flow=="string"?JSON.parse(o.flow):o.flow;a.import(e.drawflow?e:e.flow),setTimeout(()=>U(),100)}catch(e){console.error("❌ Failed to import workflow",e)}},{immediate:!0});function U(){if(!a)return;const o=document.querySelectorAll(".drawflow-node .title-box");o.forEach(e=>{const t=e.closest(".drawflow-node");if(!t)return;const n=t.id?.replace("node-","");if(!n)return;const l=a.drawflow.drawflow?.Home?.data?.[n];if(!l)return;const r=e.textContent||l.name||"Unknown",p=d.components.find($=>($.componentname||$.name)?.toLowerCase()===l.name?.toLowerCase()),k=`
      <div class="node-icon-wrapper">
        <div class="node-icon">
          <i class="${p?.componentclass||p?.icon||"fa-solid fa-cube"}"></i>
        </div>
        <div class="node-label">${r}</div>
      </div>
    `,i=t.querySelector(".drawflow_content_node");i&&(i.innerHTML=k)}),console.log(`✅ Converted ${o.length} old nodes to icon style`)}me(()=>{try{a?.destroy()}catch(o){console.error(o)}});function J(){a?.zoom_in()}function Z(){a?.zoom_out()}function V(){a?.zoom_reset()}function X(o){if(o.preventDefault(),!a)return;const e=o.dataTransfer?.getData("node");if(!e){console.warn("⚠️ drop: no data received");return}const t=JSON.parse(e),n=document.getElementById("drawflow").getBoundingClientRect(),l=o.clientX-n.left,r=o.clientY-n.top,p=t.componentclass||t.icon||"fa-solid fa-cube",R=t.componenttitle??t.label??t.name,k=`
    <div class="node-icon-wrapper">
      <div class="node-icon">
        <i class="${p}"></i>
      </div>
      <div class="node-label">${R}</div>
    </div>
  `;a.addNode(t.componentname??t.name??t.code,t.input??t.inputs??1,t.output??t.outputs??1,l,r,t.componentname??t.name,{},k),h()}function G(o){o.querySelectorAll("*").forEach(t=>{const n=window.getComputedStyle(t);n.color.includes("oklch")&&(t.style.color="#222"),n.backgroundColor.includes("oklch")&&(t.style.backgroundColor="#fff"),n.borderColor.includes("oklch")&&(t.style.borderColor="#ccc")})}async function Y(){const o=document.getElementById("drawflow");if(!o)return;G(o);const e=await be(o,{cacheBust:!0,pixelRatio:2}),t=document.createElement("a");t.download="workflow.png",t.href=e,t.click()}const K=ye(),Q=Te();function ee(o){const e={};for(const[t,n]of o.entries())e[t]=n instanceof File?n.name:n;return e}function te(o){L();const e=document.getElementById("drawflow");if(!e)return;const t=e.querySelector(".drawflow");t&&o.forEach(n=>{const l=document.getElementById(`node-${n.nodeId}`);if(!l)return;l.getBoundingClientRect(),t.getBoundingClientRect();const r=l.offsetLeft,p=l.offsetTop,R=l.offsetWidth,k=l.offsetHeight,i=document.createElement("div");i.className="node-result-panel",i.setAttribute("data-node-result",n.nodeId);const $=n.success?"#dcfce7":"#fee2e2",se=n.success?"#22c55e":"#ef4444",le=n.success?"✓":"✗",ae=n.success?"#16a34a":"#dc2626",re=Math.max(R,80);i.style.cssText=`
      position: absolute;
      left: ${r}px;
      top: ${p+k+4}px;
      min-width: ${re}px;
      background: ${$};
      border: 1px solid ${se};
      border-radius: 6px;
      padding: 8px 10px;
      font-size: 12px;
      z-index: 10;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      pointer-events: auto;
      resize: both;
      overflow: auto;
    `;const C=document.createElement("div");C.className="result-summary",C.style.cssText="display: flex; align-items: center; justify-content: space-between;",C.innerHTML=`
      <span style="color: ${ae}; font-weight: bold; font-size: 14px;">${le}</span>
      <span style="margin-left: 8px; flex: 1; color: #374151; font-size: 12px;">${n.executionTime}ms</span>
      <span style="color: #6b7280; font-size: 12px;">▼</span>
    `;const w=document.createElement("div");w.className="result-details",w.style.cssText="display: none; margin-top: 8px; border-top: 1px solid rgba(0,0,0,0.1); padding-top: 8px;";let N="";n.input&&Object.keys(n.input).length>0&&(N+=`<div style="margin-bottom: 8px;"><strong style="font-size: 12px;">Input:</strong><pre style="background: white; padding: 8px; border-radius: 4px; margin: 4px 0; overflow: auto; max-height: 150px; font-size: 11px; white-space: pre-wrap; word-break: break-all;">${JSON.stringify(n.input,null,2)}</pre></div>`),N+=`<div><strong style="font-size: 12px;">Result:</strong><pre style="background: white; padding: 8px; border-radius: 4px; margin: 4px 0; overflow: auto; max-height: 200px; font-size: 11px; white-space: pre-wrap; word-break: break-all;">${JSON.stringify(n.result,null,2)}</pre></div>`,n.error&&(N+=`<div style="color: #dc2626; margin-top: 6px; font-size: 12px;"><strong>Error:</strong> ${n.error}</div>`),w.innerHTML=N,i.addEventListener("click",ie=>{ie.stopPropagation();const B=w.style.display!=="none";w.style.display=B?"none":"block",C.querySelector("span:last-child").textContent=B?"▼":"▲",B||(i.style.minWidth="250px")}),i.appendChild(C),i.appendChild(w),t.appendChild(i)})}function L(){document.querySelectorAll(".node-result-panel").forEach(e=>e.remove())}function oe(o){const e=document.querySelector(`.node-result-panel[data-node-result="${o}"]`);if(!e)return;const t=e.querySelector(".result-details"),n=e.querySelector(".result-summary");if(t&&t.style.display!=="none"){t.style.display="none";const l=n?.querySelector("span:last-child");l&&(l.textContent="▼"),e.style.minWidth="80px"}}function M(){I.value=[],_.value="",z.value="",E.value=!1,L()}async function ne(){try{M();const o=new FormData;o.append("flowname",K.params.slug),o.append("menu","admin"),o.append("search","true"),o.append("debug","true");for(let t=0;t<d.parameters.length;t++){const n=d.parameters[t];o.append(n.parametername,n.parametervalue)}const e=await Q.post("admin/execute-flow",o);z.value=JSON.stringify(ee(o),null,2),E.value=!0,e?.code==200?e.data?.stepResults&&Array.isArray(e.data.stepResults)?(I.value=e.data.stepResults,te(e.data.stepResults),x.add({title:"Test Complete",description:`${e.data.stepResults.length} steps executed`,color:"green"})):_.value=JSON.stringify(e.data??e.message,null,2):(_.value=`Error: ${e.message}`,x.add({title:"Test Failed",description:e.message,color:"red"}))}catch(o){_.value=`Exception: ${o}`,x.add({title:"Test Error",description:String(o),color:"red"})}}return(o,e)=>(v(),g("div",_e,[E.value?(v(),g("div",Ee,[s("div",Re,[e[3]||(e[3]=s("h3",{class:"font-bold text-sm"},"Test Payload",-1)),s("button",{onClick:e[0]||(e[0]=t=>E.value=!1),class:"text-gray-400 hover:text-gray-600"},"×")]),s("pre",$e,T(z.value),1)])):S("",!0),P.value?(v(),g("div",Ne,[s("div",ze,[e[5]||(e[5]=s("h3",{class:"text-lg font-bold mb-4"},"Upload Component Plugin",-1)),s("div",Ie,[e[4]||(e[4]=s("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Select Plugin ZIP",-1)),s("input",{type:"file",accept:".zip",onChange:q,class:"w-full border rounded p-2 text-sm"},null,32)]),f.value>=0?(v(),g("div",Pe,[s("div",Oe,[s("span",null,T(y.value),1),s("span",null,T(f.value)+"%",1)]),s("div",Be,[s("div",{class:"bg-blue-600 h-2.5 rounded-full transition-all duration-300",style:we({width:f.value+"%"})},null,4)])])):S("",!0),u.value?(v(),g("div",De,T(u.value),1)):S("",!0),s("div",Fe,[s("button",{onClick:F,class:"px-3 py-1.5 text-gray-600 hover:bg-gray-100 rounded"},"Cancel"),s("button",{onClick:W,disabled:!b.value||m.value,class:"px-3 py-1.5 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"},T(m.value?"Uploading...":"Upload"),9,Ue)])])])):S("",!0),s("div",{id:"drawflow",class:"absolute inset-0",onDrop:X,onDragover:e[1]||(e[1]=ge(()=>{},["prevent"]))},null,32),s("div",Le,[s("button",{onClick:Z,class:"p-2 rounded shadow bg-white text-black",title:"Zoom Out"},"-"),s("button",{onClick:V,class:"p-2 rounded shadow bg-white text-black",title:"Reset Zoom"},"Reset"),s("button",{onClick:J,class:"p-2 rounded shadow bg-white text-black",title:"Zoom In"},"+"),e[7]||(e[7]=s("div",{class:"w-px bg-gray-300 mx-1"},null,-1)),s("button",{onClick:e[2]||(e[2]=t=>P.value=!0),class:"p-2 rounded shadow bg-white text-black flex items-center gap-1"},[...e[6]||(e[6]=[s("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[s("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),s("polyline",{points:"17 8 12 3 7 8"}),s("line",{x1:"12",y1:"3",x2:"12",y2:"15"})],-1),ve(" Upload Plugin ",-1)])]),s("button",{onClick:j,class:"p-2 rounded shadow bg-white text-black"},"Save"),s("button",{onClick:Y,class:"p-2 rounded shadow bg-white text-black"},"Export PNG"),s("button",{onClick:ne,class:"p-2 rounded shadow bg-white text-black"},"Test Flow"),A.value?(v(),g("button",{key:0,onClick:M,class:"p-2 rounded shadow bg-red-100 text-red-600 hover:bg-red-200"},"Clear Results")):S("",!0)])]))}}),Ke=Object.assign(Me,{__name:"Designer"});export{Ke as default};
