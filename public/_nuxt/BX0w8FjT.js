const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./waGlWwlO.js","./DH2n3Tqk.js","./atadKu7o.js","./KobTAp13.js","./vendor-drawflow.D47m1JE_.css","./BXI2M5or.js","./B3hjldT8.js","./entry.Bk-kIeZj.css","./vendor-icons.Bt8h_iO_.css","./vendor-vue.Bz_NoKHc.css","./C-PXSHBS.js","./k-yNuOG3.js"])))=>i.map(i=>d[i]);
import{_ as V}from"./B3hjldT8.js";import{b2 as Ce,r as y,d as J,w as te,y as Oe,a as Re,z as Pe,B as L,a_ as g,am as $e,u as f,ar as Le,aF as Ie,Y as H,ay as U,an as Fe,ak as E,P as K,aj as ne,b3 as ze}from"./DH2n3Tqk.js";import{u as Me}from"./C1AnPZyN.js";import{t as oe}from"./CCayPtYg.js";import{s as Be}from"./BXI2M5or.js";import"#entry";/* empty css        */import"./KobTAp13.js";import"./Bu8C_CX3.js";const Je=Ce("dbobject",()=>{const S=y([]),T=y({dbobjectid:"",objectname:"",dbobjecttypeid:"",objectcontent:"",objectversion:"",ispublished:0,comment:""}),h=y(!1),b=Me();async function x(){h.value=!0;try{let r=new FormData;r.append("flowname","searchcombodbobjecttype"),r.append("menu","admin"),r.append("search","true");let o=await b.post("/admin/execute-flow",r);S.value=o?.data?.data??{},r=new FormData,r.append("flowname","searchdbobject"),r.append("menu","admin"),r.append("search","true"),o=await b.post("/admin/execute-flow",r),S.value=o?.data?.data??{}}finally{h.value=!1}}async function O(r){h.value=!0;try{const o=new FormData;o.append("flowname","getdbobject"),o.append("menu","admin"),o.append("search","true"),o.append("dbobjectid",r);const u=await b.post("/admin/execute-flow",o);T.value=u?.data?.data??{}}finally{h.value=!1}}async function j(r){try{const o=new FormData;o.append("flowname","modifdbobject"),o.append("menu","admin"),o.append("search","true"),o.append("dbobjectid",r.dbobjectid),o.append("objectname",r.objectname),o.append("dbobjecttypeid",r.dbobjecttypeid),o.append("objectcontent",r.objectcontent),o.append("ispublished",r.ispublished),o.append("comment",r.comment),await b.post("/admin/execute-flow",o)}finally{h.value=!1}}async function I(r){try{const o=new FormData;o.append("flowname","purgedbobject"),o.append("menu","admin"),o.append("search","true"),o.append("dbobjectid",r),await b.post("/admin/execute-flow",o)}finally{h.value=!1}}async function D(r,o){h.value=!0;try{const u=new FormData;u.append("menu","admin"),u.append("operation",r),u.append("table",JSON.stringify(o));const p=await b.post("/admin/execute-table-operation",u);return p?.data??p}finally{h.value=!1}}return{fetchAll:x,fetch:O,saveTable:j,purgeTable:I,executeTableOperation:D,dbobject:T,dbobjects:S,loading:h}});function Ye(){const S=J([]),T=J([]),h=J([]),b=y(1),x=.1,O=.2,j=3,I=y(null),D=y({x:0,y:0}),r=y(null),o=y(null),u=y({x:0,y:0}),p=y([]),R=J({active:!1,from:null,sx:0,sy:0,path:""});function F(){b.value=Math.min(b.value+x,j)}function B(){b.value=Math.max(b.value-x,O)}function k(){b.value=1}function P(w,d,C,z){const M=(w+C)/2;return`M ${w} ${d} C ${M} ${d} ${M} ${z} ${C} ${z}`}function N(){T.forEach(w=>{const d=S.find($=>$.id===w.from.table),C=S.find($=>$.id===w.to.table);if(!d||!C)return;const z=d.y+36+w.from.col*24,M=d.x+d.width,Y=C.y+36+w.to.col*24,_=C.x;w.path=P(M,z,_,Y)})}return te(S,N,{deep:!0}),te(T,N,{deep:!0}),{tables:S,relations:T,areas:h,zoom:b,dragging:I,offset:D,activeArea:r,areaMode:o,areaOffset:u,activeAreaTables:p,linkPreview:R,zoomIn:F,zoomOut:B,resetZoom:k,makePath:P,computeRelationsPaths:N}}const Xe={class:"h-screen flex flex-col bg-gray-50"},Ze={class:"flex-1 flex overflow-hidden"},qe={class:"flex-none bg-white border-r z-10"},Ve={class:"flex-1 relative overflow-auto bg-gray-100"},He={class:"absolute inset-0 pointer-events-none",style:{overflow:"visible"}},Ue=["d"],Ke=["d"],it=Oe({__name:"dbobject",setup(S){const T=K(()=>V(()=>import("./waGlWwlO.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9]),import.meta.url)),h=K(()=>V(()=>import("./C-PXSHBS.js"),__vite__mapDeps([10,1,2,3,4,5,6,7,8,9]),import.meta.url)),b=K(()=>V(()=>import("./k-yNuOG3.js"),__vite__mapDeps([11,1,2,3,4,5,6,7,8,9]),import.meta.url));let x=1,O=1,j=1;const I=Be(),D=Je(),r=y(null),{tables:o,relations:u,areas:p,zoom:R,dragging:F,offset:B,activeArea:k,areaMode:P,areaOffset:N,activeAreaTables:w,linkPreview:d,zoomIn:C,zoomOut:z,resetZoom:M,makePath:Y,computeRelationsPaths:_}=Ye(),$=y(null),X=y(""),W=y("");y(!1);const v=Re(()=>o.find(e=>e.id===$.value)||null);function G(e){$.value=e;const t=o.find(n=>n.id===e);X.value=t?JSON.stringify(t,null,2):""}function ae(){let e=40,t=40;if(k.value){const a=k.value;e=a.x+40,t=a.y+40}const n={id:x++,dbid:"",name:`table_${x}`,x:e,y:t,width:240,columns:[{name:"id",type:"auto"},{name:"name",type:"text"}]};o.push(n)}function le(){o.length,ae()}function ie(e,t){F.value=e.id;const n=t.target.getBoundingClientRect();B.value={x:t.clientX-n.left,y:t.clientY-n.top}}function se(e){const t=r.value.getBoundingClientRect();if(!F.value)return;const n=o.find(a=>a.id===F.value);n&&(n.x=e.clientX-t.left-B.value.x,n.y=e.clientY-t.top-B.value.y,F.value=null,_())}function ce(){let e=100,t=100;if(p.length>0){const n=p[p.length-1];e=n.x+n.width+40,t=n.y}j++,p.push({id:j,name:"Area "+j,x:e,y:t,width:400,height:300,color:"#e3e9ff"})}function re(e,t){k.value=e,P.value="move",N.value={x:t.clientX-e.x,y:t.clientY-e.y},w.value=o.filter(n=>n.x>=e.x&&n.x<=e.x+e.width&&n.y>=e.y&&n.y<=e.y+e.height),window.addEventListener("mousemove",Z),window.addEventListener("mouseup",q)}function de(e,t){k.value=e,P.value="resize",N.value={x:t.clientX,y:t.clientY},window.addEventListener("mousemove",Z),window.addEventListener("mouseup",q)}function Z(e){if(!k.value)return;const t=k.value;if(P.value==="move"){const n=e.clientX-N.value.x,a=e.clientY-N.value.y,i=n-t.x,c=a-t.y;t.x=n,t.y=a,w.value.forEach(l=>{l.x+=i,l.y+=c}),_()}else P.value==="resize"&&(t.width=Math.max(100,e.clientX-t.x),t.height=Math.max(100,e.clientY-t.y))}function q(){k.value=null,w.value=[],window.removeEventListener("mousemove",Z),window.removeEventListener("mouseup",q)}function ue(e,t,n){const a=r.value.getBoundingClientRect(),i=o.find(m=>m.id===e);if(!i)return;const c=i.y+36+t*24;d.active=!0,d.from={table:e,col:t},d.sx=i.x+i.width,d.sy=c,Q(n.clientX-a.left,n.clientY-a.top);const l=m=>Q(m.clientX-a.left,m.clientY-a.top),s=m=>me(m,l,s);window.addEventListener("pointermove",l),window.addEventListener("pointerup",s)}function Q(e,t){d.path=Y(d.sx,d.sy,e,t)}function me(e,t,n){if(window.removeEventListener("pointermove",t),window.removeEventListener("pointerup",n),!d.active)return;const a=r.value.getBoundingClientRect(),i=e.clientX-a.left,c=e.clientY-a.top;let l=null;for(const s of o)if(i>=s.x&&i<=s.x+s.width&&c>=s.y&&c<=s.y+200){const m=Math.floor((c-(s.y+36))/24);if(m>=0&&m<s.columns.length){l={table:s.id,col:m};break}}if(l){const s={id:O++,from:{table:d.from.table,col:d.from.col,colName:o.find(A=>A.id===d.from.table).columns[d.from.col].name},to:{table:l.table,col:l.col,colName:o.find(A=>A.id===l.table).columns[l.col].name},path:""};u.some(A=>A.from.table===d.from.table&&A.from.col===d.from.col&&A.to.table===l.table&&A.to.col===l.col)||(u.push(s),_())}d.active=!1,d.path=""}function fe(e){const t=JSON.parse(JSON.stringify(e));t.id=x++,t.dbid="",t.x+=20,t.y+=20,t.name=e.name+"_copy",o.push(t),_()}async function pe(e){if(!confirm("Are you sure to delete Table?"))return;const t=o.findIndex(a=>a.id===e),n=o.find(a=>a.id===e);n.dbid&&await D.purgeTable(n.dbid),t>=0&&o.splice(t,1);for(let a=u.length-1;a>=0;a--)(u[a].from.table===e||u[a].to.table===e)&&u.splice(a,1)}async function be(e){if(!confirm("Are you sure to delete Area ?"))return;const t=p.findIndex(n=>n.id===e);t>=0&&p.splice(t,1)}function ve(){v.value&&v.value.columns.push({name:"new_col",type:"varchar"})}function ye(e){v.value&&v.value.columns.splice(e,1)}function he(e){const t=u.findIndex(n=>n.id===e);t>=0&&u.splice(t,1)}function we(e){if(v.value)try{const t=JSON.parse(e);v.value.name=t.name||v.value.name,v.value.x=Number(t.x??v.value.x),v.value.y=Number(t.y??v.value.y),v.value.width=Number(t.width??v.value.width),Array.isArray(t.columns)&&(v.value.columns=t.columns),_(),alert("Applied to selected table")}catch(t){console.error(t),alert("Invalid JSON")}}function ge(e){navigator.clipboard.writeText(e).then(()=>alert("Copied"))}async function xe(){confirm("Reset design?")&&await ee()}function Ae(){console.log("AI Suggest Relations")}function Se(e){console.log("AI Parse",e)}function je(e){console.log("AI Suggest Columns",e)}function ke(){r.value!==null&&oe(r.value,{cacheBust:!0,filter:e=>e.tagName!=="i"}).then(e=>{const t=document.createElement("a");t.download="database-design.png",t.href=e,t.click()}).catch(e=>{console.error(e)})}function _e(e){const t=document.createElement("div");t.style.position="absolute",t.style.left="0",t.style.top="0",t.style.background="white",t.style.padding="10px";const n=document.querySelector(`[data-area-id="${e.id}"]`);if(!n)return;const a=n.cloneNode(!0);a.style.position="relative",a.style.left="0",a.style.top="0",t.appendChild(a),o.forEach(i=>{if(i.x>=e.x&&i.x<=e.x+e.width&&i.y>=e.y&&i.y<=e.y+e.height){const c=document.querySelector(`[data-table-id="${i.id}"]`);if(c){const l=c.cloneNode(!0);l.style.position="absolute",l.style.left=i.x-e.x+"px",l.style.top=i.y-e.y+"px",t.appendChild(l)}}}),document.body.appendChild(t),oe(t,{cacheBust:!0}).then(i=>{const c=document.createElement("a");c.download=`${e.name}.png`,c.href=i,c.click(),document.body.removeChild(t)})}async function Ee(){if(!o.length)return alert("No tables to save");try{for(const e of ze(o)){const t={table:e,relations:u.filter(l=>l.from.table===e.id||l.to.table===e.id).map(l=>({id:l.id,from:{...l.from,table:o.find(s=>s.id===l.from.table)?.dbid},to:{...l.to,table:o.find(s=>s.id===l.to.table)?.dbid}})),areas:p},n={dbobjectid:e.dbid?String(e.dbid):"",objectname:e.name,dbobjecttypeid:"1",objectcontent:JSON.stringify(t),objectversion:"1",ispublished:e.ispublished?1:0,comment:e.comment||""},a=await D.saveTable(n),i=a?.data?.data??a,c=i?.dbobjectid??i?.dbobjectid??null;if(c){const l=o.find(s=>s.id===e.id);l&&(l.dbid=c)}}I.add({title:"Success",description:"Runtime schema saved successfully",color:"success"})}catch(e){console.error(e),I.add({title:"Error",description:String(e),color:"error"})}}async function ee(){o.splice(0,o.length),u.splice(0,u.length),p.splice(0,p.length),x=1,j=1,O=1,$.value=null,await D.fetchAll();const e=new Set,t=[],n={};(D.dbobjects||[]).forEach(a=>{const i=a?.dbobjectid?String(a.dbobjectid):a?.objectname??"";i&&(e.has(i)||(e.add(i),t.push(a)))}),t.forEach((a,i)=>{const c=Te(a,i);n[a.dbobjectid]=c.id,o.push(c)}),x=Math.max(...o.map(a=>a.id),0)+1,Ne(t,n),_()}function Te(e,t){let n=0,a=0,i=120,c=[];if(e.objectcontent)try{const s=JSON.parse(e.objectcontent);s?.table?.columns&&Array.isArray(s.table.columns)&&(c=s.table.columns.map(m=>({name:m.name||"col",type:m.type||"text",allownull:m.allownull??!1,default:m.default??""}))),n=s?.table?.x??40+t%4*340,a=s?.table?.y??40+Math.floor(t/4)*200,i=s?.table?.width??240,s.areas&&s.areas.length>0&&s.areas.forEach(m=>{p.find(A=>A.id==m.id)==null&&De(m)})}catch(s){console.warn(`Invalid objectcontent JSON for ${e.objectname}`,s)}return{id:x++,dbid:e.dbobjectid??"",name:e.objectname||`table_${t+1}`,x:n,y:a,width:i,columns:c,ispublished:e.ispublished==1,comment:e.comment??""}}function De(e){const t={id:e.id,name:e.name,x:e.x,y:e.y,width:e.width,height:e.height,color:e.color,type:"area"};p.push(t),j=e.id}function Ne(e,t){u.splice(0,u.length);const n=new Set;e.forEach(a=>{if(!a.objectcontent)return;let i=null;try{i=JSON.parse(a.objectcontent)}catch{return}Array.isArray(i.relations)&&i.relations.forEach(c=>{const l=t[c.from.table],s=t[c.to.table];if(!l||!s)return;const m=`${l}|${c.from.col}|${s}|${c.to.col}`;n.has(m)||(n.add(m),u.push({id:O++,from:{table:l,col:c.from.col,colName:c.from.colName},to:{table:s,col:c.to.col,colName:c.to.colName},path:""}))})}),_()}return Pe(async()=>{await ee()}),(e,t)=>(E(),L("div",Xe,[t[5]||(t[5]=g("header",{class:"flex items-center justify-between p-4 border-b bg-white sticky"},[g("div",{class:"flex items-center gap-3"},[g("h1",{class:"text-xl font-semibold"},"Database Designer")])],-1)),g("div",Ze,[g("div",qe,[$e(f(T),{tables:f(o),areas:f(p),selectedTable:v.value,relations:f(u),jsonPreview:X.value,aiDescription:W.value,onAddTable:le,onAddArea:ce,onSave:Ee,onReset:xe,onAiSuggest:Ae,onSelectTable:G,onZoomIn:f(C),onZoomOut:f(z),onResetZoom:f(M),onExportPng:ke,"onUpdate:jsonPreview":t[0]||(t[0]=n=>X.value=n),"onUpdate:aiDescription":t[1]||(t[1]=n=>W.value=n),onAiParse:Se,onRemoveColumn:ye,onAddColumn:ve,onAiSuggestTypes:je,onApplyJson:we,onCopyJson:ge,onRemoveRelation:he},null,8,["tables","areas","selectedTable","relations","jsonPreview","aiDescription","onZoomIn","onZoomOut","onResetZoom"])]),g("div",Ve,[g("div",{class:"relative p-4 min-w-[2000px] min-h-[2000px]",onDragover:t[2]||(t[2]=Ie(()=>{},["prevent"])),onDrop:se,ref_key:"canvasRef",ref:r,id:"drawflow",style:Le({transform:`scale(${f(R)})`,transformOrigin:"0 0",width:f(R)<1?`${100/f(R)}%`:"100%",height:f(R)<1?`${100/f(R)}%`:"100%"})},[(E(!0),L(H,null,U(f(p),n=>(E(),ne(f(b),{key:n.id,area:n,onStartDrag:re,onStartResize:de,onExport:_e,onDelete:be},null,8,["area"]))),128)),(E(),L("svg",He,[t[3]||(t[3]=g("defs",null,[g("marker",{id:"arrow",markerWidth:"10",markerHeight:"10",refX:"10",refY:"5",orient:"auto"},[g("path",{d:"M0,0 L10,5 L0,10 z",fill:"black"})])],-1)),(E(!0),L(H,null,U(f(u),n=>(E(),L("g",{key:n.id},[g("path",{d:n.path,stroke:"black","stroke-width":"2",fill:"none","marker-end":"url(#arrow)"},null,8,Ue)]))),128)),f(d).active?(E(),L("path",{key:0,d:f(d).path,stroke:"gray","stroke-width":"2",fill:"none","stroke-dasharray":"6 4"},null,8,Ke)):Fe("",!0)])),(E(!0),L(H,null,U(f(o),n=>(E(),ne(f(h),{key:n.id,table:n,onDragstart:ie,onSelect:G,onDuplicate:fe,onDelete:pe,onStartLink:ue},null,8,["table"]))),128)),t[4]||(t[4]=g("div",{class:"absolute left-4 bottom-4"},null,-1))],36)])])]))}});export{it as default};
