import{q as Me,k as D,e as K,s as _,c as w,h as Z,a as o,t as E,m as N,v as U,x as re,F as V,r as M,o as y,y as Le,z as Be,A as oe,B as Fe,b as S,d as Y,C as ne,D as de,n as J,E as le,j as Q,l as Je,g as P,G as qe}from"#entry";import{u as Ye}from"./CM07dtpo.js";import{t as ue}from"./CCayPtYg.js";import{_ as Ze}from"./CMWow-hH.js";import{_ as ce}from"./on0lOAqo.js";import{u as Xe}from"./C1IErGjn.js";import"./Bhw12tYx.js";import"./CD2XDZmH.js";import"./BtOf2Fb3.js";import"./boeIpb6B.js";const Ge=Me("dbobject",()=>{const a=D([]),$=D({dbobjectid:"",objectname:"",dbobjecttypeid:"",objectcontent:"",objectversion:"",ispublished:0,comment:""}),m=D(!1),h=Ye();async function p(){m.value=!0;try{let u=new FormData;u.append("flowname","searchcombodbobjecttype"),u.append("menu","admin"),u.append("search","true");let s=await h.post("/admin/execute-flow",u);a.value=s?.data?.data??{},u=new FormData,u.append("flowname","searchdbobject"),u.append("menu","admin"),u.append("search","true"),s=await h.post("/admin/execute-flow",u),a.value=s?.data?.data??{}}finally{m.value=!1}}async function x(u){m.value=!0;try{const s=new FormData;s.append("flowname","getdbobject"),s.append("menu","admin"),s.append("search","true"),s.append("dbobjectid",u);const n=await h.post("/admin/execute-flow",s);$.value=n?.data?.data??{}}finally{m.value=!1}}async function d(u){try{const s=new FormData;s.append("flowname","modifdbobject"),s.append("menu","admin"),s.append("search","true"),s.append("dbobjectid",u.dbobjectid),s.append("objectname",u.objectname),s.append("dbobjecttypeid",u.dbobjecttypeid),s.append("objectcontent",u.objectcontent),s.append("ispublished",u.ispublished),s.append("comment",u.comment),await h.post("/admin/execute-flow",s)}finally{m.value=!1}}async function l(u){try{const s=new FormData;s.append("flowname","purgedbobject"),s.append("menu","admin"),s.append("search","true"),s.append("dbobjectid",u),await h.post("/admin/execute-flow",s)}finally{m.value=!1}}async function k(u,s){m.value=!0;try{const n=new FormData;n.append("menu","admin"),n.append("operation",u),n.append("table",JSON.stringify(s));const j=await h.post("/admin/execute-table-operation",n);return j?.data??j}finally{m.value=!1}}return{fetchAll:p,fetch:x,saveTable:d,purgeTable:l,executeTableOperation:k,dbobject:$,dbobjects:a,loading:m}}),He={class:"h-full flex flex-col bg-white p-4 overflow-auto"},Ke={key:0,class:"space-y-4"},We={class:"text-lg font-semibold"},Qe={class:"flex gap-2 mt-1"},_e={class:"mt-2 space-y-2"},et=["onUpdate:modelValue"],tt=["onUpdate:modelValue"],ot=["onUpdate:modelValue"],nt=["onUpdate:modelValue"],lt=["onClick"],st={class:"flex gap-2"},at={class:"flex gap-2 mt-1"},it={class:"mt-4"},rt={key:0},dt={class:"text-sm"},ut={class:"flex gap-2"},ct=["onClick"],mt={key:1,class:"text-gray-400 text-sm"},pt=K({__name:"PropertiesPanel",props:{selectedTable:{},relations:{},jsonPreview:{}},emits:["ai-parse","remove-column","add-column","ai-suggest-types","apply-json","copy-json","remove-relation","update:jsonPreview"],setup(a,{emit:$}){const m=a,h=$,p=_({get:()=>m.jsonPreview,set:x=>h("update:jsonPreview",x)});return(x,d)=>(y(),w("div",He,[a.selectedTable?(y(),w("div",Ke,[o("h2",We,"Properties — "+E(a.selectedTable.name||"Untitled"),1),o("div",null,[d[11]||(d[11]=o("label",{class:"text-sm text-gray-600"},"Table Name",-1)),N(o("input",{"onUpdate:modelValue":d[0]||(d[0]=l=>a.selectedTable.name=l),class:"w-full mt-1 p-2 border rounded"},null,512),[[U,a.selectedTable.name]])]),o("div",null,[d[12]||(d[12]=o("label",{class:"text-sm text-gray-600"},"Comment",-1)),N(o("input",{"onUpdate:modelValue":d[1]||(d[1]=l=>a.selectedTable.comment=l),class:"w-full mt-1 p-2 border rounded"},null,512),[[U,a.selectedTable.comment]])]),o("div",null,[d[13]||(d[13]=o("label",{class:"text-sm text-gray-600"},"Is Published",-1)),N(o("input",{type:"checkbox","onUpdate:modelValue":d[2]||(d[2]=l=>a.selectedTable.ispublished=l),class:"w-full mt-1 p-2 border rounded"},null,512),[[re,a.selectedTable.ispublished]])]),o("div",null,[d[14]||(d[14]=o("label",{class:"text-sm text-gray-600"},"Position",-1)),o("div",Qe,[N(o("input",{type:"number","onUpdate:modelValue":d[3]||(d[3]=l=>a.selectedTable.x=l),class:"w-1/3 p-2 border rounded"},null,512),[[U,a.selectedTable.x,void 0,{number:!0}]]),N(o("input",{type:"number","onUpdate:modelValue":d[4]||(d[4]=l=>a.selectedTable.y=l),class:"w-1/3 p-2 border rounded"},null,512),[[U,a.selectedTable.y,void 0,{number:!0}]]),N(o("input",{type:"number","onUpdate:modelValue":d[5]||(d[5]=l=>a.selectedTable.width=l),class:"w-1/3 p-2 border rounded"},null,512),[[U,a.selectedTable.width,void 0,{number:!0}]])])]),o("div",null,[d[16]||(d[16]=o("label",{class:"text-sm text-gray-600"},"Columns",-1)),o("div",_e,[(y(!0),w(V,null,M(a.selectedTable.columns,(l,k)=>(y(),w("div",{key:k,class:"flex items-center gap-2"},[N(o("input",{"onUpdate:modelValue":u=>l.name=u,placeholder:"name",class:"flex-1 p-2 border rounded"},null,8,et),[[U,l.name]]),N(o("select",{"onUpdate:modelValue":u=>l.type=u,placeholder:"type",class:"w-36 p-2 border rounded"},[...d[15]||(d[15]=[Be('<option value="auto">Auto Increment</option><option value="text">Text</option><option value="longtext">Long Text</option><option value="number">Number</option><option value="integer">Integer</option><option value="timestamp">Time stamp</option><option value="boolean">Boolean</option>',7)])],8,tt),[[Le,l.type]]),N(o("input",{type:"checkbox","onUpdate:modelValue":u=>l.allownull=u,placeholder:"type",class:"w-36 p-2 border rounded"},null,8,ot),[[re,l.allownull]]),N(o("input",{"onUpdate:modelValue":u=>l.default=u,placeholder:"default",class:"flex-1 p-2 border rounded"},null,8,nt),[[U,l.default]]),o("button",{onClick:u=>x.$emit("remove-column",k),class:"px-2 py-1 bg-red-500 text-white rounded"},"-",8,lt)]))),128)),o("div",st,[o("button",{onClick:d[6]||(d[6]=l=>x.$emit("add-column")),class:"px-3 py-1 bg-blue-600 text-white rounded"},"Add Column"),o("button",{onClick:d[7]||(d[7]=l=>x.$emit("ai-suggest-types",a.selectedTable)),class:"px-3 py-1 bg-yellow-500 text-white rounded"}," AI Suggest Types ")])])]),o("div",null,[d[17]||(d[17]=o("label",{class:"text-sm text-gray-600"},"Raw JSON",-1)),N(o("textarea",{"onUpdate:modelValue":d[8]||(d[8]=l=>p.value=l),rows:"6",class:"w-full p-2 border rounded mt-1 text-xs font-mono"},null,512),[[U,p.value]]),o("div",at,[o("button",{onClick:d[9]||(d[9]=l=>x.$emit("apply-json",p.value)),class:"px-3 py-1 bg-green-600 text-white rounded text-xs"}," Apply "),o("button",{onClick:d[10]||(d[10]=l=>x.$emit("copy-json",p.value)),class:"px-3 py-1 bg-gray-500 text-white rounded text-xs"}," Copy ")])])])):Z("",!0),o("div",it,[d[18]||(d[18]=o("h3",{class:"font-semibold"},"Relations",-1)),a.relations.length?(y(),w("div",rt,[(y(!0),w(V,null,M(a.relations,l=>(y(),w("div",{key:l.id,class:"flex items-center justify-between mt-2"},[o("div",dt,E(l.from.table)+"."+E(l.from.col)+" ➜ "+E(l.to.table)+"."+E(l.to.col??"-"),1),o("div",ut,[o("button",{onClick:k=>x.$emit("remove-relation",l.id),class:"px-2 py-1 bg-red-500 text-white rounded"}," Delete ",8,ct)])]))),128))])):(y(),w("div",mt,"No relations"))])]))}}),bt=Object.assign(pt,{__name:"PropertiesPanel"}),ft={class:"h-full flex flex-row bg-white text-gray-900 shadow-sm border-r"},vt={class:"panel w-12 flex flex-col items-center py-2 border-r border-gray-700 z-20"},yt=["onClick","title"],gt={key:0,class:"absolute left-0 top-0 bottom-0 w-1 bg-blue-500"},xt={class:"w-80 flex flex-col border-r transition-all duration-300 ease-in-out"},wt={class:"p-3 border-b flex justify-between items-center"},ht={class:"font-semibold text-sm uppercase text-gray-600"},$t={class:"flex-1 overflow-auto p-3"},kt={key:0,class:"space-y-4"},jt={class:"grid grid-cols-1 gap-2"},Ct={class:"mt-4"},Tt={class:"flex gap-2 mt-1"},At={class:"grid grid-cols-2 gap-2"},St={class:"grid grid-cols-2 gap-2"},Dt={key:1},Pt={class:"space-y-1 mb-4"},Nt=["onClick"],Ot={class:"truncate"},Et={class:"space-y-1"},Rt={class:"truncate"},zt={key:2,class:"h-full"},Ut={key:1,class:"text-gray-500 text-sm italic text-center mt-10"},It=K({__name:"DbObjectSidebar",props:{tables:{},areas:{},selectedTable:{},relations:{},jsonPreview:{},aiDescription:{}},emits:["add-table","add-area","save","reset","ai-suggest","select-table","zoom-in","zoom-out","reset-zoom","export-png","update:jsonPreview","update:aiDescription","ai-parse","remove-column","add-column","ai-suggest-types","apply-json","copy-json","remove-relation"],setup(a,{emit:$}){const m=a,h=$,p=D("toolbox"),x=D(!0),d=[{id:"toolbox",label:"Toolbox",icon:"heroicons:squares-plus"},{id:"explorer",label:"Explorer",icon:"heroicons:list-bullet"},{id:"properties",label:"Properties",icon:"heroicons:cog-6-tooth"}],l=_(()=>d.find(s=>s.id===p.value)?.label||"");function k(s){p.value===s?x.value=!x.value:(p.value=s,x.value=!0)}oe(()=>m.selectedTable,s=>{s&&(p.value="properties",x.value=!0)});const u=_({get:()=>m.aiDescription,set:s=>h("update:aiDescription",s)});return(s,n)=>{const j=Ze;return y(),w("div",ft,[o("div",vt,[(y(),w(V,null,M(d,r=>o("button",{key:r.id,class:de(["w-full relative flex justify-center py-3 mb-1 hover:bg-gray-700 transition-colors",p.value===r.id&&x.value?"text-white":"text-gray-400 hover:text-gray-200"]),onClick:L=>k(r.id),title:r.label},[p.value===r.id&&x.value?(y(),w("div",gt)):Z("",!0),S(j,{name:r.icon,class:"w-6 h-6"},null,8,["name"])],10,yt)),64))]),N(o("div",xt,[o("div",wt,[o("span",ht,E(l.value),1),o("button",{onClick:n[0]||(n[0]=r=>x.value=!1),class:"text-gray-500 hover:text-gray-700"},[S(j,{name:"heroicons:x-mark",class:"w-4 h-4"})])]),o("div",$t,[p.value==="toolbox"?(y(),w("div",kt,[o("div",null,[n[25]||(n[25]=o("h3",{class:"font-semibold text-sm text-gray-700 mb-2 uppercase tracking-wider"},"Actions",-1)),o("div",jt,[o("button",{onClick:n[1]||(n[1]=r=>s.$emit("add-table")),class:"flex items-center gap-2 px-3 py-2 bg-white border rounded hover:bg-gray-50 text-sm"},[S(j,{name:"heroicons:table-cells",class:"w-5 h-5 text-green-600"}),n[21]||(n[21]=o("span",null,"Add Table",-1))]),o("button",{onClick:n[2]||(n[2]=r=>s.$emit("add-area",r)),class:"flex items-center gap-2 px-3 py-2 bg-white border rounded hover:bg-gray-50 text-sm"},[S(j,{name:"heroicons:square-3-stack-3d",class:"w-5 h-5 text-purple-600"}),n[22]||(n[22]=o("span",null,"Add Area",-1))]),o("button",{onClick:n[3]||(n[3]=r=>s.$emit("ai-suggest")),class:"flex items-center gap-2 px-3 py-2 bg-white border rounded hover:bg-gray-50 text-sm"},[S(j,{name:"heroicons:building-library",class:"w-5 h-5 text-purple-500"}),n[23]||(n[23]=o("span",null,"AI Suggest Relations",-1))])]),o("div",Ct,[n[24]||(n[24]=o("label",{class:"text-sm font-semibold"},"AI Prompt",-1)),o("div",Tt,[N(o("textarea",{"onUpdate:modelValue":n[4]||(n[4]=r=>u.value=r),placeholder:"e.g. Customer table with id, name, email",class:"flex-1 p-2 border rounded"},null,512),[[U,u.value]]),o("button",{onClick:n[5]||(n[5]=r=>s.$emit("ai-parse",u.value)),class:"px-3 py-1 bg-yellow-500 text-white rounded"}," Generate ")])])]),o("div",null,[n[28]||(n[28]=o("h3",{class:"font-semibold text-sm text-gray-700 mb-2 uppercase tracking-wider"},"Project",-1)),o("div",At,[o("button",{onClick:n[6]||(n[6]=r=>s.$emit("save")),class:"flex flex-col border items-center justify-center p-2 bg-green-600 text-white rounded hover:bg-green-700 text-xs"},[S(j,{name:"heroicons:bookmark-square",class:"w-5 h-5 mb-1"}),n[26]||(n[26]=Y(" Save ",-1))]),o("button",{onClick:n[7]||(n[7]=r=>s.$emit("reset")),class:"flex flex-col border items-center justify-center p-2 bg-red-500 text-white rounded hover:bg-red-600 text-xs"},[S(j,{name:"heroicons:arrows-right-left",class:"w-5 h-5 mb-1"}),n[27]||(n[27]=Y(" Reset ",-1))])])]),o("div",null,[n[33]||(n[33]=o("h3",{class:"font-semibold text-sm text-gray-700 mb-2 uppercase tracking-wider"},"View",-1)),o("div",St,[o("button",{onClick:n[8]||(n[8]=r=>s.$emit("zoom-in")),class:"p-2 bg-white border rounded hover:bg-gray-50 text-xs flex flex-col items-center"},[S(j,{name:"heroicons:magnifying-glass-plus",class:"w-4 h-4 mb-1"}),n[29]||(n[29]=Y(" Zoom In ",-1))]),o("button",{onClick:n[9]||(n[9]=r=>s.$emit("zoom-out")),class:"p-2 bg-white border rounded hover:bg-gray-50 text-xs flex flex-col items-center"},[S(j,{name:"heroicons:magnifying-glass-minus",class:"w-4 h-4 mb-1"}),n[30]||(n[30]=Y(" Zoom Out ",-1))]),o("button",{onClick:n[10]||(n[10]=r=>s.$emit("reset-zoom")),class:"p-2 bg-white border rounded hover:bg-gray-50 text-xs flex flex-col items-center col-span-2"},[S(j,{name:"heroicons:arrows-right-left",class:"w-4 h-4 mb-1"}),n[31]||(n[31]=Y(" Reset Zoom ",-1))]),o("button",{onClick:n[11]||(n[11]=r=>s.$emit("export-png")),class:"p-2 bg-indigo-500 border text-white rounded hover:bg-indigo-600 text-xs flex flex-col items-center col-span-2"},[S(j,{name:"heroicons:bars-4",class:"w-4 h-4 mb-1"}),n[32]||(n[32]=Y(" Export PNG ",-1))])])])])):Z("",!0),p.value==="explorer"?(y(),w("div",Dt,[n[34]||(n[34]=o("h3",{class:"font-semibold text-sm text-gray-700 mb-2 uppercase tracking-wider"},"Tables",-1)),o("ul",Pt,[(y(!0),w(V,null,M(a.tables,r=>(y(),w("li",{key:r.id,onClick:L=>s.$emit("select-table",r.id),class:de(["px-2 py-1 rounded cursor-pointer text-sm hover:bg-gray-200 flex items-center gap-2",{"bg-blue-100 text-blue-700":a.selectedTable?.id===r.id}])},[S(j,{name:"heroicons:table-cells",class:"w-4 h-4 text-gray-500"}),o("span",Ot,E(r.name),1)],10,Nt))),128))]),n[35]||(n[35]=o("h3",{class:"font-semibold text-sm text-gray-700 mb-2 uppercase tracking-wider"},"Areas",-1)),o("ul",Et,[(y(!0),w(V,null,M(a.areas,r=>(y(),w("li",{key:r.id,class:"px-2 py-1 rounded cursor-pointer text-sm hover:bg-gray-200 flex items-center gap-2"},[S(j,{name:"heroicons:square-3-stack-3d",class:"w-4 h-4 text-gray-500"}),o("span",Rt,E(r.name),1)]))),128))])])):Z("",!0),p.value==="properties"?(y(),w("div",zt,[a.selectedTable?(y(),ne(bt,{key:0,selectedTable:a.selectedTable,relations:a.relations,jsonPreview:a.jsonPreview,aiDescription:a.aiDescription,"onUpdate:jsonPreview":n[12]||(n[12]=r=>s.$emit("update:jsonPreview",r)),"onUpdate:aiDescription":n[13]||(n[13]=r=>s.$emit("update:aiDescription",r)),onAiParse:n[14]||(n[14]=r=>s.$emit("ai-parse",r)),onRemoveColumn:n[15]||(n[15]=r=>s.$emit("remove-column",r)),onAddColumn:n[16]||(n[16]=r=>s.$emit("add-column")),onAiSuggestTypes:n[17]||(n[17]=r=>s.$emit("ai-suggest-types",r)),onApplyJson:n[18]||(n[18]=r=>s.$emit("apply-json",r)),onCopyJson:n[19]||(n[19]=r=>s.$emit("copy-json",r)),onRemoveRelation:n[20]||(n[20]=r=>s.$emit("remove-relation",r))},null,8,["selectedTable","relations","jsonPreview","aiDescription"])):(y(),w("div",Ut," Select a table to view properties. "))])):Z("",!0)])],512),[[Fe,x.value]])])}}}),Vt=Object.assign(It,{__name:"DbObjectSidebar"}),Mt=["data-table-id"],Lt={class:"flex items-center justify-between p-2 bg-gray-800 text-white rounded-t"},Bt={class:"font-medium"},Ft={class:"flex gap-1"},Jt={class:"p-2 text-xs"},qt=["data-col-index"],Yt={class:"w-6 text-gray-600"},Zt={class:"flex-1 truncate"},Xt={class:"text-gray-500 text-[11px]"},Gt=["onPointerdown"],Ht=K({__name:"CanvasTable",props:{table:{type:Object,required:!0}},emits:["dragstart","select","duplicate","delete","start-link"],setup(a){return($,m)=>{const h=ce;return y(),w("div",{class:"absolute shadow-lg rounded border bg-white cursor-move",style:le({left:a.table.x+"px",top:a.table.y+"px",width:a.table.width+"px"}),draggable:"true",onDragstart:m[2]||(m[2]=p=>$.$emit("dragstart",a.table,p)),onDblclick:m[3]||(m[3]=p=>$.$emit("select",a.table.id)),"data-table-id":a.table.id},[o("div",Lt,[o("div",Bt,E(a.table.name||"table_"+a.table.id),1),o("div",Ft,[S(h,{icon:"heroicons:document-duplicate",onClick:m[0]||(m[0]=J(p=>$.$emit("duplicate",a.table),["stop"])),title:"Duplicate",class:"text-xs px-2"}),S(h,{icon:"heroicons:trash",onClick:m[1]||(m[1]=J(p=>$.$emit("delete",a.table.id),["stop"])),title:"Delete",class:"text-xs px-2"})])]),o("div",Jt,[(y(!0),w(V,null,M(a.table.columns,(p,x)=>(y(),w("div",{key:x,class:"flex items-center gap-2","data-col-index":x},[o("span",Yt,E(x+1),1),o("span",Zt,E(p.name),1),o("span",Xt,E(p.type||""),1),o("button",{onPointerdown:J(d=>$.$emit("start-link",a.table.id,x,d),["stop","prevent"]),class:"w-4 h-4 rounded-full bg-blue-500",title:"Start relation"},null,40,Gt)],8,qt))),128))])],44,Mt)}}}),Kt=Object.assign(Ht,{__name:"CanvasTable"}),Wt={class:"bg-purple-600 text-white text-xs px-2 py-1 rounded-t-xl cursor-move flex items-center justify-between"},Qt={class:"flex items-center"},_t=K({__name:"CanvasArea",props:{area:{type:Object,required:!0}},emits:["start-drag","start-resize","export","delete"],setup(a){return($,m)=>{const h=ce;return y(),w("div",{class:"absolute rounded-xl border border-purple-400 bg-purple-200/30",style:le({left:a.area.x+"px",top:a.area.y+"px",width:a.area.width+"px",height:a.area.height+"px"}),onMousedown:m[4]||(m[4]=p=>$.$emit("start-drag",a.area,p))},[o("div",Wt,[N(o("input",{"onUpdate:modelValue":m[0]||(m[0]=p=>a.area.name=p),class:"bg-purple-600 outline-none flex-1 rounded px-2"},null,512),[[U,a.area.name]]),o("div",Qt,[S(h,{onClick:m[1]||(m[1]=J(p=>$.$emit("export",a.area),["stop"])),class:"text-white hover:text-blue-300 font-bold mr-2",title:"Export Area",icon:"heroicons:arrow-down-tray"}),S(h,{onClick:m[2]||(m[2]=J(p=>$.$emit("delete",a.area.id),["stop"])),class:"text-white hover:text-red-300 font-bold",title:"Delete Area",icon:"heroicons:trash"})])]),o("div",{class:"absolute bottom-0 right-0 w-4 h-4 bg-purple-600 cursor-se-resize rounded",onMousedown:m[3]||(m[3]=J(p=>$.$emit("start-resize",a.area,p),["stop"]))},null,32)],36)}}}),eo=Object.assign(_t,{__name:"CanvasArea"});function to(){const a=Q([]),$=Q([]),m=Q([]),h=D(1),p=.1,x=.2,d=3,l=D(null),k=D({x:0,y:0}),u=D(null),s=D(null),n=D({x:0,y:0}),j=D([]),r=Q({active:!1,from:null,sx:0,sy:0,path:""});function L(){h.value=Math.min(h.value+p,d)}function q(){h.value=Math.max(h.value-p,x)}function X(){h.value=1}function T(R,I,B,O){const F=(R+B)/2;return`M ${R} ${I} C ${F} ${I} ${F} ${O} ${B} ${O}`}function G(){$.forEach(R=>{const I=a.find(A=>A.id===R.from.table),B=a.find(A=>A.id===R.to.table);if(!I||!B)return;const O=I.y+36+R.from.col*24,F=I.x+I.width,H=B.y+36+R.to.col*24,W=B.x;R.path=T(F,O,W,H)})}return oe(a,G,{deep:!0}),oe($,G,{deep:!0}),{tables:a,relations:$,areas:m,zoom:h,dragging:l,offset:k,activeArea:u,areaMode:s,areaOffset:n,activeAreaTables:j,linkPreview:r,zoomIn:L,zoomOut:q,resetZoom:X,makePath:T,computeRelationsPaths:G}}const oo={class:"h-screen flex flex-col bg-gray-50"},no={class:"flex-1 flex overflow-hidden"},lo={class:"flex-none bg-white border-r z-10"},so={class:"flex-1 relative overflow-auto bg-gray-100"},ao={class:"absolute inset-0 pointer-events-none",style:{overflow:"visible"}},io=["d"],ro=["d"],wo=K({__name:"dbobject",setup(a){let $=1,m=1,h=1;const p=Xe(),x=Ge(),d=D(null),{tables:l,relations:k,areas:u,zoom:s,dragging:n,offset:j,activeArea:r,areaMode:L,areaOffset:q,activeAreaTables:X,linkPreview:T,zoomIn:G,zoomOut:R,resetZoom:I,makePath:B,computeRelationsPaths:O}=to(),F=D(null),H=D(""),W=D("");D(!1);const A=_(()=>l.find(e=>e.id===F.value)||null);function se(e){F.value=e;const t=l.find(i=>i.id===e);H.value=t?JSON.stringify(t,null,2):""}function me(){let e=40,t=40;if(r.value){const c=r.value;e=c.x+40,t=c.y+40}const i={id:$++,dbid:"",name:`table_${$}`,x:e,y:t,width:240,columns:[{name:"id",type:"auto"},{name:"name",type:"text"}]};l.push(i)}function pe(){l.length,me()}function be(e,t){n.value=e.id;const i=t.target.getBoundingClientRect();j.value={x:t.clientX-i.left,y:t.clientY-i.top}}function fe(e){const t=d.value.getBoundingClientRect();if(!n.value)return;const i=l.find(c=>c.id===n.value);i&&(i.x=e.clientX-t.left-j.value.x,i.y=e.clientY-t.top-j.value.y,n.value=null,O())}function ve(){let e=100,t=100;if(u.length>0){const i=u[u.length-1];e=i.x+i.width+40,t=i.y}h++,u.push({id:h,name:"Area "+h,x:e,y:t,width:400,height:300,color:"#e3e9ff"})}function ye(e,t){r.value=e,L.value="move",q.value={x:t.clientX-e.x,y:t.clientY-e.y},X.value=l.filter(i=>i.x>=e.x&&i.x<=e.x+e.width&&i.y>=e.y&&i.y<=e.y+e.height),window.addEventListener("mousemove",ee),window.addEventListener("mouseup",te)}function ge(e,t){r.value=e,L.value="resize",q.value={x:t.clientX,y:t.clientY},window.addEventListener("mousemove",ee),window.addEventListener("mouseup",te)}function ee(e){if(!r.value)return;const t=r.value;if(L.value==="move"){const i=e.clientX-q.value.x,c=e.clientY-q.value.y,f=i-t.x,g=c-t.y;t.x=i,t.y=c,X.value.forEach(b=>{b.x+=f,b.y+=g}),O()}else L.value==="resize"&&(t.width=Math.max(100,e.clientX-t.x),t.height=Math.max(100,e.clientY-t.y))}function te(){r.value=null,X.value=[],window.removeEventListener("mousemove",ee),window.removeEventListener("mouseup",te)}function xe(e,t,i){const c=d.value.getBoundingClientRect(),f=l.find(C=>C.id===e);if(!f)return;const g=f.y+36+t*24;T.active=!0,T.from={table:e,col:t},T.sx=f.x+f.width,T.sy=g,ae(i.clientX-c.left,i.clientY-c.top);const b=C=>ae(C.clientX-c.left,C.clientY-c.top),v=C=>we(C,b,v);window.addEventListener("pointermove",b),window.addEventListener("pointerup",v)}function ae(e,t){T.path=B(T.sx,T.sy,e,t)}function we(e,t,i){if(window.removeEventListener("pointermove",t),window.removeEventListener("pointerup",i),!T.active)return;const c=d.value.getBoundingClientRect(),f=e.clientX-c.left,g=e.clientY-c.top;let b=null;for(const v of l)if(f>=v.x&&f<=v.x+v.width&&g>=v.y&&g<=v.y+200){const C=Math.floor((g-(v.y+36))/24);if(C>=0&&C<v.columns.length){b={table:v.id,col:C};break}}if(b){const v={id:m++,from:{table:T.from.table,col:T.from.col,colName:l.find(z=>z.id===T.from.table).columns[T.from.col].name},to:{table:b.table,col:b.col,colName:l.find(z=>z.id===b.table).columns[b.col].name},path:""};k.some(z=>z.from.table===T.from.table&&z.from.col===T.from.col&&z.to.table===b.table&&z.to.col===b.col)||(k.push(v),O())}T.active=!1,T.path=""}function he(e){const t=JSON.parse(JSON.stringify(e));t.id=$++,t.dbid="",t.x+=20,t.y+=20,t.name=e.name+"_copy",l.push(t),O()}async function $e(e){if(!confirm("Are you sure to delete Table?"))return;const t=l.findIndex(c=>c.id===e),i=l.find(c=>c.id===e);i.dbid&&await x.purgeTable(i.dbid),t>=0&&l.splice(t,1);for(let c=k.length-1;c>=0;c--)(k[c].from.table===e||k[c].to.table===e)&&k.splice(c,1)}async function ke(e){if(!confirm("Are you sure to delete Area ?"))return;const t=u.findIndex(i=>i.id===e);t>=0&&u.splice(t,1)}function je(){A.value&&A.value.columns.push({name:"new_col",type:"varchar"})}function Ce(e){A.value&&A.value.columns.splice(e,1)}function Te(e){const t=k.findIndex(i=>i.id===e);t>=0&&k.splice(t,1)}function Ae(e){if(A.value)try{const t=JSON.parse(e);A.value.name=t.name||A.value.name,A.value.x=Number(t.x??A.value.x),A.value.y=Number(t.y??A.value.y),A.value.width=Number(t.width??A.value.width),Array.isArray(t.columns)&&(A.value.columns=t.columns),O(),alert("Applied to selected table")}catch(t){console.error(t),alert("Invalid JSON")}}function Se(e){navigator.clipboard.writeText(e).then(()=>alert("Copied"))}async function De(){confirm("Reset design?")&&await ie()}function Pe(){console.log("AI Suggest Relations")}function Ne(e){console.log("AI Parse",e)}function Oe(e){console.log("AI Suggest Columns",e)}function Ee(){d.value!==null&&ue(d.value,{cacheBust:!0,filter:e=>e.tagName!=="i"}).then(e=>{const t=document.createElement("a");t.download="database-design.png",t.href=e,t.click()}).catch(e=>{console.error(e)})}function Re(e){const t=document.createElement("div");t.style.position="absolute",t.style.left="0",t.style.top="0",t.style.background="white",t.style.padding="10px";const i=document.querySelector(`[data-area-id="${e.id}"]`);if(!i)return;const c=i.cloneNode(!0);c.style.position="relative",c.style.left="0",c.style.top="0",t.appendChild(c),l.forEach(f=>{if(f.x>=e.x&&f.x<=e.x+e.width&&f.y>=e.y&&f.y<=e.y+e.height){const g=document.querySelector(`[data-table-id="${f.id}"]`);if(g){const b=g.cloneNode(!0);b.style.position="absolute",b.style.left=f.x-e.x+"px",b.style.top=f.y-e.y+"px",t.appendChild(b)}}}),document.body.appendChild(t),ue(t,{cacheBust:!0}).then(f=>{const g=document.createElement("a");g.download=`${e.name}.png`,g.href=f,g.click(),document.body.removeChild(t)})}async function ze(){if(!l.length)return alert("No tables to save");try{for(const e of qe(l)){const t={table:e,relations:k.filter(b=>b.from.table===e.id||b.to.table===e.id).map(b=>({id:b.id,from:{...b.from,table:l.find(v=>v.id===b.from.table)?.dbid},to:{...b.to,table:l.find(v=>v.id===b.to.table)?.dbid}})),areas:u},i={dbobjectid:e.dbid?String(e.dbid):"",objectname:e.name,dbobjecttypeid:"1",objectcontent:JSON.stringify(t),objectversion:"1",ispublished:e.ispublished?1:0,comment:e.comment||""},c=await x.saveTable(i),f=c?.data?.data??c,g=f?.dbobjectid??f?.dbobjectid??null;if(g){const b=l.find(v=>v.id===e.id);b&&(b.dbid=g)}}p.add({title:"Success",description:"Runtime schema saved successfully",color:"success"})}catch(e){console.error(e),p.add({title:"Error",description:String(e),color:"error"})}}async function ie(){l.splice(0,l.length),k.splice(0,k.length),u.splice(0,u.length),$=1,h=1,m=1,F.value=null,await x.fetchAll();const e=new Set,t=[],i={};(x.dbobjects||[]).forEach(c=>{const f=c?.dbobjectid?String(c.dbobjectid):c?.objectname??"";f&&(e.has(f)||(e.add(f),t.push(c)))}),t.forEach((c,f)=>{const g=Ue(c,f);i[c.dbobjectid]=g.id,l.push(g)}),$=Math.max(...l.map(c=>c.id),0)+1,Ve(t,i),O()}function Ue(e,t){let i=0,c=0,f=120,g=[];if(e.objectcontent)try{const v=JSON.parse(e.objectcontent);v?.table?.columns&&Array.isArray(v.table.columns)&&(g=v.table.columns.map(C=>({name:C.name||"col",type:C.type||"text",allownull:C.allownull??!1,default:C.default??""}))),i=v?.table?.x??40+t%4*340,c=v?.table?.y??40+Math.floor(t/4)*200,f=v?.table?.width??240,v.areas&&v.areas.length>0&&v.areas.forEach(C=>{u.find(z=>z.id==C.id)==null&&Ie(C)})}catch(v){console.warn(`Invalid objectcontent JSON for ${e.objectname}`,v)}return{id:$++,dbid:e.dbobjectid??"",name:e.objectname||`table_${t+1}`,x:i,y:c,width:f,columns:g,ispublished:e.ispublished==1,comment:e.comment??""}}function Ie(e){const t={id:e.id,name:e.name,x:e.x,y:e.y,width:e.width,height:e.height,color:e.color,type:"area"};u.push(t),h=e.id}function Ve(e,t){k.splice(0,k.length);const i=new Set;e.forEach(c=>{if(!c.objectcontent)return;let f=null;try{f=JSON.parse(c.objectcontent)}catch{return}Array.isArray(f.relations)&&f.relations.forEach(g=>{const b=t[g.from.table],v=t[g.to.table];if(!b||!v)return;const C=`${b}|${g.from.col}|${v}|${g.to.col}`;i.has(C)||(i.add(C),k.push({id:m++,from:{table:b,col:g.from.col,colName:g.from.colName},to:{table:v,col:g.to.col,colName:g.to.colName},path:""}))})}),O()}return Je(async()=>{await ie()}),(e,t)=>(y(),w("div",oo,[t[5]||(t[5]=o("header",{class:"flex items-center justify-between p-4 border-b bg-white sticky"},[o("div",{class:"flex items-center gap-3"},[o("h1",{class:"text-xl font-semibold"},"Database Designer")])],-1)),o("div",no,[o("div",lo,[S(Vt,{tables:P(l),areas:P(u),selectedTable:A.value,relations:P(k),jsonPreview:H.value,aiDescription:W.value,onAddTable:pe,onAddArea:ve,onSave:ze,onReset:De,onAiSuggest:Pe,onSelectTable:se,onZoomIn:P(G),onZoomOut:P(R),onResetZoom:P(I),onExportPng:Ee,"onUpdate:jsonPreview":t[0]||(t[0]=i=>H.value=i),"onUpdate:aiDescription":t[1]||(t[1]=i=>W.value=i),onAiParse:Ne,onRemoveColumn:Ce,onAddColumn:je,onAiSuggestTypes:Oe,onApplyJson:Ae,onCopyJson:Se,onRemoveRelation:Te},null,8,["tables","areas","selectedTable","relations","jsonPreview","aiDescription","onZoomIn","onZoomOut","onResetZoom"])]),o("div",so,[o("div",{class:"relative p-4 min-w-[2000px] min-h-[2000px]",onDragover:t[2]||(t[2]=J(()=>{},["prevent"])),onDrop:fe,ref_key:"canvasRef",ref:d,id:"drawflow",style:le({transform:`scale(${P(s)})`,transformOrigin:"0 0",width:P(s)<1?`${100/P(s)}%`:"100%",height:P(s)<1?`${100/P(s)}%`:"100%"})},[(y(!0),w(V,null,M(P(u),i=>(y(),ne(eo,{key:i.id,area:i,onStartDrag:ye,onStartResize:ge,onExport:Re,onDelete:ke},null,8,["area"]))),128)),(y(),w("svg",ao,[t[3]||(t[3]=o("defs",null,[o("marker",{id:"arrow",markerWidth:"10",markerHeight:"10",refX:"10",refY:"5",orient:"auto"},[o("path",{d:"M0,0 L10,5 L0,10 z",fill:"black"})])],-1)),(y(!0),w(V,null,M(P(k),i=>(y(),w("g",{key:i.id},[o("path",{d:i.path,stroke:"black","stroke-width":"2",fill:"none","marker-end":"url(#arrow)"},null,8,io)]))),128)),P(T).active?(y(),w("path",{key:0,d:P(T).path,stroke:"gray","stroke-width":"2",fill:"none","stroke-dasharray":"6 4"},null,8,ro)):Z("",!0)])),(y(!0),w(V,null,M(P(l),i=>(y(),ne(Kt,{key:i.id,table:i,onDragstart:be,onSelect:se,onDuplicate:he,onDelete:$e,onStartLink:xe},null,8,["table"]))),128)),t[4]||(t[4]=o("div",{class:"absolute left-4 bottom-4"},null,-1))],36)])])]))}});export{wo as default};
