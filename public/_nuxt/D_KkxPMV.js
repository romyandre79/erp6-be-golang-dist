import{q as oe,k as C,e as M,i as ne,l as G,x as q,aH as ae,E as re,c as p,o as u,h as j,a as d,t as I,n as K,aI as se,F as A,r as z,m as P,v as B,A as X,g as O,j as le,_ as de,H,b as W,G as ce,I as ie}from"#entry";import{u as Y}from"./Dn5qd4Zw.js";import{t as ue}from"./CCayPtYg.js";import{u as pe}from"./BinpDrU3.js";import"./BJSp6O0t.js";const J=oe("workflow",()=>{const N=C(null),m=C([]),c=C([]),f=C([]),y=C([]),r=C([]),i=C(null),w=C([]),v=C(!1),b=Y();async function T(t){v.value=!0;try{const e=new FormData;e.append("flowname","getworkflow"),e.append("menu","admin"),e.append("search","true"),e.append("workflowid",t),e.append("wfname",t);const h=(await b.post("/admin/execute-flow",e))?.data?.data??{},x=h?.flow;if(x&&typeof x=="string")try{h.flow=JSON.parse(x)}catch(te){console.error("Failed parsing flow string",te),h.flow=null}N.value=h;const $=new FormData;$.append("flowname","searchcombocomponentcategory"),$.append("menu","admin"),$.append("search","true");const _=await b.post("/admin/execute-flow",$);m.value=_.data?.data??[];const D=new FormData;D.append("flowname","searchcombocomponent"),D.append("menu","admin"),D.append("search","true");const k=await b.post("/admin/execute-flow",D);c.value=k.data?.data??[];const U=new FormData;U.append("flowname","searchwfparameter"),U.append("menu","admin"),U.append("search","true"),U.append("wfname",t);const Q=await b.post("/admin/execute-flow",U);w.value=Q.data?.data??[];const L=new FormData;L.append("flowname","searchcomponentdetails"),L.append("menu","admin"),L.append("search","true");const Z=await b.post("/admin/execute-flow",L);y.value=Z.data?.data??[];const R=new FormData;R.append("flowname","searchwfdetailbywfname"),R.append("menu","admin"),R.append("search","true"),R.append("wfname",t);const ee=await b.post("/admin/execute-flow",R);f.value=ee.data?.data??[]}finally{v.value=!1}}function E(t){return c.value.find(e=>e.code===t||e.componentname===t||e.name===t)}async function V(t,e){const o=y.value.filter(_=>_.componentname===t),h=f.value.filter(_=>_.componentname===t&&Number(_.nodeid)===Number(e)),x=new Map;h.forEach(_=>{x.set(_.componentdetailid||_.inputname,_)});const $=o.map(_=>{const D=_.componentdetailid||_.inputname,k=x.get(D);return{..._,workflowdetailid:k?.workflowdetailid??0,workflowid:k?.workflowid??0,componentvalue:k?.componentvalue??""}});return r.value=$,$}function F(t,e){return y.value.find(o=>o.componentname===t&&o.inputname===e)||null}function s(t,e,o){return f.value.find(h=>h.componentid===t&&h.componentdetailid===e&&Number(h.nodeid)===Number(o))?.workflowdetailid??""}async function g(t){const e=t?.drawflow?.Home?.data??{};for(const o of Object.values(e)){const h=o?.name,x=o?.data??{};for(const $ of Object.keys(x)){const _=F(h,$);if(!_){console.warn("Meta not found:",h,$);continue}const D=s(_.componentid,_.componentdetailid,o.id),k=new FormData;k.append("flowname","modifworkflowdetail"),k.append("menu","admin"),k.append("search","false"),k.append("workflowid",N.value?.workflowid??""),k.append("componentid",_.componentid),k.append("componentdetailid",_.componentdetailid),k.append("workflowdetailid",D||""),k.append("componentvalue",x[$]),k.append("nodeid",o.id),await b.post("/admin/execute-flow",k)}}}async function a(){for(let t=0;t<w.value.length;t++){const e=w.value[t],o=new FormData;o.append("flowname","modifwfparameter"),o.append("menu","admin"),o.append("search","false"),o.append("workflowid",N.value?.workflowid??""),o.append("wfparameterid",e.wfparameterid??""),o.append("parametername",e.parametername??""),o.append("parametervalue",e.parametervalue??""),o.append("parametertype",e.parametertype??""),await b.post("/admin/execute-flow",o)}}async function l(t){v.value=!0;try{const e=new FormData;e.append("flowname","saveflow"),e.append("menu","admin"),e.append("search","false"),e.append("workflowid",N.value?.workflowid??""),e.append("flow",JSON.stringify(t));const o=await b.post("/admin/execute-flow",e);return await g(t),await a(),await T(N.value?.wfname),o}finally{v.value=!1}}function S(t){i.value=t}function n(t){if(!i.value)return;const e=window.editor;if(!e)return;const o=e.drawflow?.drawflow?.Home?.data;if(!o)return;const h=Object.keys(o).find(x=>Number(o[x].id)===Number(i.value.id));h&&(o[h].data={...o[h].data||{},...t},e.drawflow.drawflow.Home.data=o,l(e.export()))}return{workflow:N,categories:m,components:c,componentProperties:r,selectedNode:i,parameters:w,loading:v,loadWorkflow:T,findComponentByName:E,loadComponentProperties:V,saveFlow:l,setSelectedNode:S,updateSelectedNodeData:n}}),me={class:"relative h-full"},fe={key:0,id:"test-result-overlay",class:"absolute top-6 left-6 p-4 bg-white shadow-xl rounded border z-50 max-w-md"},we={class:"text-sm whitespace-pre-wrap"},ve=M({__name:"Designer",setup(N){const{t:m}=ne(),c=J(),f=pe(),y=C("");let r=null,i=null;function w(n){const{$drawflow:t}=se();if(!t)return console.error("❌ Drawflow plugin not available"),null;const e=new t(n);return e.reroute=!0,e.reroute_fix_curvature=!0,e.force_first_input=!1,e.start(),e.on("nodeCreated",()=>v()),e.on("nodeRemoved",()=>v()),e.on("connectionCreated",()=>v()),e.on("connectionRemoved",()=>v()),e.on("nodeSelected",async o=>{const h=o.replace("node-",""),x=e.drawflow.drawflow?.Home?.data?.[h];x&&(await c.loadComponentProperties(x.name,h.toString()),c.setSelectedNode(x))}),e}function v(){i&&clearTimeout(i),i=setTimeout(()=>{try{c.saveFlow(r.export())}catch(n){console.error("❌ saveFlow error",n)}},500)}async function b(){try{const n=await c.saveFlow(r.export());n.code==200&&f.add({title:m("TITLE UPDATE"),description:m(n.message.replaceAll("_"," "))})}catch(n){console.error("❌ saveFlow error",n)}}G(async()=>{const n=document.getElementById("drawflow");if(!n){console.error("❌ drawflow element not found");return}r=w(n),window.editor=r;const t=c.workflow?.flow;if(t&&r)try{r.import(t)}catch(e){console.error("❌ ERROR IMPORT DRAWFLOW",e)}}),q(()=>c.workflow,n=>{if(!(!n||!n.flow||!r))try{const t=typeof n.flow=="string"?JSON.parse(n.flow):n.flow;r.import(t.drawflow?t:t.flow)}catch(t){console.error("❌ Failed to import workflow",t)}},{immediate:!0}),ae(()=>{try{r?.destroy()}catch(n){console.error(n)}});function T(){r?.zoom_in()}function E(){r?.zoom_out()}function V(){r?.zoom_reset()}function F(n){if(n.preventDefault(),!r)return;const t=n.dataTransfer?.getData("node");if(!t){console.warn("⚠️ drop: no data received");return}const e=JSON.parse(t),o=document.getElementById("drawflow").getBoundingClientRect(),h=n.clientX-o.left,x=n.clientY-o.top;r.addNode(e.componentname??e.name??e.code,e.input??e.inputs??1,e.output??e.outputs??1,h,x,e.componentname??e.name,{},`<div class='title-box'>${e.componenttitle??e.label??e.name}</div>`),v()}function s(n){n.querySelectorAll("*").forEach(e=>{const o=window.getComputedStyle(e);o.color.includes("oklch")&&(e.style.color="#222"),o.backgroundColor.includes("oklch")&&(e.style.backgroundColor="#fff"),o.borderColor.includes("oklch")&&(e.style.borderColor="#ccc")})}async function g(){const n=document.getElementById("drawflow");if(!n)return;s(n);const t=await ue(el,{cacheBust:!0,pixelRatio:2}),e=document.createElement("a");e.download="workflow.png",e.href=t,e.click()}const a=re(),l=Y();async function S(){try{const n=new FormData;n.append("flowname",a.params.slug),n.append("menu","admin"),n.append("search","true");for(let e=0;e<c.parameters.length;e++){const o=c.parameters[e];n.append(o.parametername,o.parametervalue)}const t=await l.post("admin/execute-flow",n);t?.code==200?y.value=JSON.stringify(t.data??t.message,null,2):y.value=`Error: ${t.message}`}catch(n){y.value=`Exception: ${n}`}}return(n,t)=>(u(),p("div",me,[y.value?(u(),p("div",fe,[t[1]||(t[1]=d("h3",{class:"font-bold text-lg"},"Test Result",-1)),d("pre",we,I(y.value),1)])):j("",!0),d("div",{id:"drawflow",class:"absolute inset-0",onDrop:F,onDragover:t[0]||(t[0]=K(()=>{},["prevent"]))},null,32),d("div",{class:"absolute right-6 top-6 flex flex-row gap-2 z-50"},[d("button",{onClick:E,class:"p-2 rounded shadow bg-white text-black"},"-"),d("button",{onClick:V,class:"p-2 rounded shadow bg-white text-black"},"Reset"),d("button",{onClick:T,class:"p-2 rounded shadow bg-white text-black"},"+"),d("button",{onClick:b,class:"p-2 rounded shadow bg-white text-black"},"Save"),d("button",{onClick:g,class:"p-2 rounded shadow bg-white text-black"},"Export PNG"),d("button",{onClick:S,class:"p-2 rounded shadow bg-white text-black"},"Test Flow")])]))}}),be=Object.assign(ve,{__name:"Designer"}),ye=["onUpdate:modelValue"],he=["onUpdate:modelValue"],ge=["onUpdate:modelValue","onChange"],_e=["onClick"],xe=M({__name:"FlowParameter",setup(N){const m=J();function c(){m.parameters.push({wfparameterid:"",parametername:"",parametervalue:"",parametertype:"string"})}function f(r){m.parameters=m.parameters.filter(i=>i.wfparameterid!==r)}function y(r){if(r.type==="number"&&(r.value=Number(r.value)||0),r.type==="boolean"&&(r.value=r.value==="true"),r.type==="json")try{r.value=JSON.stringify(JSON.parse(r.value),null,2)}catch{r.value="{}"}}return(r,i)=>(u(),p("div",null,[i[1]||(i[1]=d("h3",{class:"font-semibold mb-3"},"Flow Parameters",-1)),d("button",{onClick:c,class:"px-3 py-1 bg-blue-500 text-white rounded mb-3"},"Add Parameter"),(u(!0),p(A,null,z(O(m).parameters,(w,v)=>(u(),p("div",{key:w.wfparameterid??v,class:"flex items-center gap-2 mb-2"},[P(d("input",{"onUpdate:modelValue":b=>w.parametername=b,placeholder:"param name (e.g. search)",class:"border p-2 rounded flex-1"},null,8,ye),[[B,w.parametername]]),P(d("input",{"onUpdate:modelValue":b=>w.parametervalue=b,placeholder:"value",class:"border p-2 rounded flex-1"},null,8,he),[[B,w.parametervalue]]),P(d("select",{"onUpdate:modelValue":b=>w.parametertype=b,class:"border p-2 rounded w-32",onChange:b=>y(w)},[...i[0]||(i[0]=[d("option",{value:"string"},"string",-1),d("option",{value:"number"},"number",-1),d("option",{value:"boolean"},"boolean",-1),d("option",{value:"json"},"json",-1)])],40,ge),[[X,w.parametertype]]),d("button",{onClick:b=>f(w.wfparameterid),class:"text-red-500 font-bold hover:text-red-700"},"✕",8,_e)]))),128))]))}}),ke=Object.assign(xe,{__name:"FlowParameter"}),Ne={class:"space-y-4"},Ce={class:"flex items-center justify-between"},$e={class:"text-lg font-semibold"},Fe={key:0,class:"text-sm text-gray-500"},De={class:"block text-sm font-medium text-gray-700"},Se=["onUpdate:modelValue","placeholder","onInput"],Oe=["onUpdate:modelValue","placeholder","onInput"],Ie=["onUpdate:modelValue","onChange"],Pe={key:0,value:""},Te=["value"],Ee=["onUpdate:modelValue","onInput"],je={key:4,class:"text-xs text-gray-400"},Ve=M({__name:"PropertyForm",props:{componentName:{type:String,required:!1},nodeId:{type:[String,Number],required:!1}},setup(N){const m=N,c=J(),f=le({}),y=C([]);function r(s,g=500){let a=null;return function(...l){clearTimeout(a),a=setTimeout(()=>s.apply(this,l),g)}}function i(s){return(s.inputtype??"").toLowerCase()==="textbox"}function w(s){return(s.inputtype??"").toLowerCase()==="textarea"}function v(s){return(s.inputtype??"").toLowerCase()==="combobox"||(s.inputtype??"").toLowerCase()==="select"}function b(s){const g=s.datasource;return!!(g&&g.length)}function T(s){return s?s.datasourcetype&&s.datasourcetype.toLowerCase()==="list"&&s.datasource?s.datasource.split(",").map(g=>g.trim()):Array.isArray(s.datasource)?s.datasource:[]:[]}function E(){y.value.sort((a,l)=>(Number(a.order)||0)-(Number(l.order)||0));let s={};const g=window.editor;if(g){const a=g.drawflow?.drawflow?.Home?.data,l=c.selectedNode;if(a&&l){const S=Object.keys(a).find(n=>Number(a[n].id)===Number(l.id));S&&a[S]?.data&&(s=a[S].data)}}y.value.forEach(a=>{const l=a.inputname;s&&Object.prototype.hasOwnProperty.call(s,l)?f[l]=s[l]:f[l]=a.componentvalue??""})}const V=r(()=>{const s={};y.value.forEach(g=>{s[g.inputname]=f[g.inputname]}),c.updateSelectedNodeData(s)},500);function F(s){V()}return q([()=>m.componentName,()=>m.nodeId],async([s,g])=>{if(!s){y.value=[],Object.keys(f).forEach(l=>delete f[l]);return}const a=await c.loadComponentProperties(s,g);y.value=a,E()},{immediate:!0}),q(()=>c.selectedNode,s=>{s&&E()},{deep:!0}),(s,g)=>(u(),p("div",Ne,[d("div",Ce,[d("h3",$e,I(N.componentName??"Properties"),1)]),y.value.length===0?(u(),p("div",Fe,"No properties available for this component.")):(u(),p("form",{key:1,class:"space-y-3",onSubmit:g[0]||(g[0]=K(()=>{},["prevent"]))},[(u(!0),p(A,null,z(y.value,a=>(u(),p("div",{key:a.componentdetailid,class:"space-y-1"},[d("label",De,I(a.lable??a.inputname),1),i(a)?P((u(),p("input",{key:0,"onUpdate:modelValue":l=>f[a.inputname]=l,placeholder:a.inputdesc||"",class:"w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300",onInput:l=>F()},null,40,Se)),[[B,f[a.inputname]]]):w(a)?P((u(),p("textarea",{key:1,"onUpdate:modelValue":l=>f[a.inputname]=l,placeholder:a.inputdesc||"",rows:"4",class:"w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300",onInput:l=>F()},null,40,Oe)),[[B,f[a.inputname]]]):v(a)?P((u(),p("select",{key:2,"onUpdate:modelValue":l=>f[a.inputname]=l,class:"w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300",onChange:l=>F()},[b(a)?j("",!0):(u(),p("option",Pe,"-- select --")),(u(!0),p(A,null,z(T(a),l=>(u(),p("option",{key:l,value:l},I(l),9,Te))),128))],40,Ie)),[[X,f[a.inputname]]]):P((u(),p("input",{key:3,"onUpdate:modelValue":l=>f[a.inputname]=l,class:"w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300",onInput:l=>F()},null,40,Ee)),[[B,f[a.inputname]]]),a.inputdesc?(u(),p("p",je,I(a.inputdesc),1)):j("",!0)]))),128))],32))]))}}),Ue=Object.assign(de(Ve,[["__scopeId","data-v-29511cde"]]),{__name:"PropertyForm"}),Re={class:"h-full flex flex-col bg-white text-gray-900 shadow-sm border-l"},Be={class:"flex border-b"},Ae={class:"flex-1 overflow-auto p-3"},ze={key:0},Me={class:"font-semibold text-sm text-gray-700 mb-2"},Je=["onDragstart"],Le={class:"text-sm"},He={key:1},qe={key:2},We={key:1,class:"text-gray-500"},Ge=M({__name:"Sidebar",setup(N){const m=C("toolbox"),c=J();function f(r){return c.components.filter(i=>i?i.categoryname===r.categoryname:!1)}function y(r,i){r.dataTransfer?.setData("node",JSON.stringify(i))}return(r,i)=>(u(),p("div",Re,[d("div",Be,[d("button",{class:H(["px-4 py-2",m.value==="toolbox"?"bg-blue-500 text-white":""]),onClick:i[0]||(i[0]=w=>m.value="toolbox")}," Toolbox ",2),d("button",{class:H(["px-4 py-2",m.value==="parameter"?"bg-blue-500 text-white":""]),onClick:i[1]||(i[1]=w=>m.value="parameter")}," Flow Parameter ",2),d("button",{class:H(["px-4 py-2",m.value==="property"?"bg-blue-500 text-white":""]),onClick:i[2]||(i[2]=w=>m.value="property")}," Property ",2)]),d("div",Ae,[m.value==="toolbox"?(u(),p("div",ze,[(u(!0),p(A,null,z(O(c).categories,w=>(u(),p("div",{key:w.id,class:"mb-4"},[d("div",Me,I(w.categoryname??w.label??w.name),1),d("div",null,[(u(!0),p(A,null,z(f(w),v=>(u(),p("div",{key:v.componentname??v.code??v.name,draggable:"true",onDragstart:b=>y(b,v),class:"p-2 border rounded mb-2 cursor-grab flex items-center gap-2"},[d("i",{class:H(v.componentclass??v.icon)},null,2),d("span",Le,I(v.componenttitle??v.label??v.name),1)],40,Je))),128))])]))),128))])):j("",!0),m.value==="parameter"?(u(),p("div",He,[W(ke)])):j("",!0),m.value==="property"?(u(),p("div",qe,[O(c).selectedNode?(u(),ce(Ue,{key:0,componentName:O(c).selectedNode.name,nodeId:O(c).selectedNode.nodeid??O(c).selectedNode.id??O(c).selectedNode.data?.nodeid},null,8,["componentName","nodeId"])):(u(),p("div",We,"Select a node to edit properties"))])):j("",!0)])]))}}),Ke=Object.assign(Ge,{__name:"Sidebar"}),Xe={class:"h-screen flex overflow-hidden"},Ye={class:"flex-1 relative bg-gray-100"},Qe={class:"w-80 bg-white border-l"},at=M({__name:"[...slug]",setup(N){const m=ie(),c=J();return G(async()=>{const f=m.params.slug??m.params.id??m.query.id;f&&await c.loadWorkflow(f)}),(f,y)=>(u(),p("div",Xe,[d("div",Ye,[W(be)]),d("div",Qe,[W(Ke)])]))}});export{at as default};
