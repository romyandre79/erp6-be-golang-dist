const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./CwAVoXAH.js","./DirAx5lA.js","./DeaaFGeh.js","./KobTAp13.js","./vendor-drawflow.D47m1JE_.css","./CHaV0QvJ.js","./DQ_kd7ue.js","./entry.BVOpBULD.css","./vendor-icons.Bt8h_iO_.css","./vendor-vue.Bz_NoKHc.css","./B3QHE4Xo.js","./CfGfHLnu.js"])))=>i.map(i=>d[i]);
import{_ as U}from"./DQ_kd7ue.js";import{b2 as Oe,r as w,d as X,w as ie,y as Pe,a as Me,z as Fe,B as P,a_ as S,am as ze,u as h,ar as Be,aF as Je,Y as G,ay as Q,an as Ye,ak as j,P as ee,aj as le,b3 as Xe}from"./DirAx5lA.js";import{u as We}from"./mra8fcCZ.js";import{t as se}from"./CCayPtYg.js";import{s as Ze}from"./CHaV0QvJ.js";import"#entry";/* empty css        */import"./KobTAp13.js";import"./CoedoqIK.js";const qe=Oe("dbobject",()=>{const T=w([]),k=w({dbobjectid:"",objectname:"",dbobjecttypeid:"",objectcontent:"",objectversion:"",ispublished:0,comment:""}),x=w(!1),v=We();async function g(){x.value=!0;try{let d=new FormData;d.append("flowname","searchcombodbobjecttype"),d.append("menu","admin"),d.append("search","true");let a=await v.post("/admin/execute-flow",d);T.value=a?.data?.data??{},d=new FormData,d.append("flowname","searchdbobject"),d.append("menu","admin"),d.append("search","true"),a=await v.post("/admin/execute-flow",d),T.value=a?.data?.data??{}}finally{x.value=!1}}async function $(d){x.value=!0;try{const a=new FormData;a.append("flowname","getdbobject"),a.append("menu","admin"),a.append("search","true"),a.append("dbobjectid",d);const u=await v.post("/admin/execute-flow",a);k.value=u?.data?.data??{}}finally{x.value=!1}}async function _(d){try{const a=new FormData;a.append("flowname","modifdbobject"),a.append("menu","admin"),a.append("search","true"),a.append("dbobjectid",d.dbobjectid),a.append("objectname",d.objectname),a.append("dbobjecttypeid",d.dbobjecttypeid),a.append("objectcontent",d.objectcontent),a.append("ispublished",d.ispublished),a.append("comment",d.comment),await v.post("/admin/execute-flow",a)}finally{x.value=!1}}async function y(d){try{const a=new FormData;a.append("flowname","purgedbobject"),a.append("menu","admin"),a.append("search","true"),a.append("dbobjectid",d),await v.post("/admin/execute-flow",a)}finally{x.value=!1}}async function L(d,a){x.value=!0;try{const u=new FormData;u.append("menu","admin"),u.append("operation",d),u.append("table",JSON.stringify(a));const m=await v.post("/admin/execute-table-operation",u);return m?.data??m}finally{x.value=!1}}return{fetchAll:g,fetch:$,saveTable:_,purgeTable:y,executeTableOperation:L,dbobject:k,dbobjects:T,loading:x}});function Ve(){const T=X([]),k=X([]),x=X([]),v=w(1),g=.1,$=.2,_=3,y=w(null),L=w({x:0,y:0}),d=w(null),a=w(null),u=w({x:0,y:0}),m=w([]),R=X({active:!1,from:null,sx:0,sy:0,path:""});function M(){v.value=Math.min(v.value+g,_)}function J(){v.value=Math.max(v.value-g,$)}function N(){v.value=1}function I(C,f,D,F){const z=(C+D)/2;return`M ${C} ${f} C ${z} ${f} ${z} ${F} ${D} ${F}`}function E(){k.forEach(C=>{const f=T.find(O=>O.id===C.from.table),D=T.find(O=>O.id===C.to.table);if(!f||!D)return;const F=f.y+36+C.from.col*24,z=f.x+f.width,W=D.y+36+C.to.col*24,A=D.x;C.path=I(z,F,A,W)})}return ie(T,E,{deep:!0}),ie(k,E,{deep:!0}),{tables:T,relations:k,areas:x,zoom:v,dragging:y,offset:L,activeArea:d,areaMode:a,areaOffset:u,activeAreaTables:m,linkPreview:R,zoomIn:M,zoomOut:J,resetZoom:N,makePath:I,computeRelationsPaths:E}}const He={class:"h-screen flex flex-col bg-gray-50"},Ke={class:"flex-1 flex overflow-hidden"},Ue={class:"flex-none bg-white border-r z-10"},Ge={class:"flex-1 relative overflow-auto bg-gray-100"},Qe={class:"absolute inset-0 pointer-events-none",style:{overflow:"visible"}},et=["d"],tt=["d"],ut=Pe({__name:"dbobject",setup(T){const k=ee(()=>U(()=>import("./CwAVoXAH.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9]),import.meta.url)),x=ee(()=>U(()=>import("./B3QHE4Xo.js"),__vite__mapDeps([10,1,2,3,4,5,6,7,8,9]),import.meta.url)),v=ee(()=>U(()=>import("./CfGfHLnu.js"),__vite__mapDeps([11,1,2,3,4,5,6,7,8,9]),import.meta.url));let g=1,$=1,_=1;const y=Ze(),L=qe(),d=w(null),{tables:a,relations:u,areas:m,zoom:R,dragging:M,offset:J,activeArea:N,areaMode:I,areaOffset:E,activeAreaTables:C,linkPreview:f,zoomIn:D,zoomOut:F,resetZoom:z,makePath:W,computeRelationsPaths:A}=Ve(),O=w(null),Z=w(""),te=w("");w(!1);const b=Me(()=>a.find(e=>e.id===O.value)||null);function q(e){O.value=e;const t=a.find(n=>n.id===e);Z.value=t?JSON.stringify(t,null,2):""}function ce(){let e=40,t=40;if(N.value){const l=N.value;e=l.x+40,t=l.y+40}const n={id:g++,dbid:"",name:`table_${g}`,x:e,y:t,width:240,columns:[{name:"id",type:"auto"},{name:"name",type:"text"}]};a.push(n)}function re(){a.length,ce()}function de(e,t){M.value=e.id;const n=t.target.getBoundingClientRect();J.value={x:t.clientX-n.left,y:t.clientY-n.top}}function ue(e){const t=d.value.getBoundingClientRect();if(!M.value)return;const n=a.find(l=>l.id===M.value);n&&(n.x=e.clientX-t.left-J.value.x,n.y=e.clientY-t.top-J.value.y,M.value=null,A())}function fe(){let e=100,t=100;if(m.length>0){const n=m[m.length-1];e=n.x+n.width+40,t=n.y}_++,m.push({id:_,name:"Area "+_,x:e,y:t,width:400,height:300,color:"#e3e9ff"})}function me(e,t){N.value=e,I.value="move",E.value={x:t.clientX-e.x,y:t.clientY-e.y},C.value=a.filter(n=>n.x>=e.x&&n.x<=e.x+e.width&&n.y>=e.y&&n.y<=e.y+e.height),window.addEventListener("mousemove",V),window.addEventListener("mouseup",H)}function pe(e,t){N.value=e,I.value="resize",E.value={x:t.clientX,y:t.clientY},window.addEventListener("mousemove",V),window.addEventListener("mouseup",H)}function V(e){if(!N.value)return;const t=N.value;if(I.value==="move"){const n=e.clientX-E.value.x,l=e.clientY-E.value.y,c=n-t.x,i=l-t.y;t.x=n,t.y=l,C.value.forEach(o=>{o.x+=c,o.y+=i}),A()}else I.value==="resize"&&(t.width=Math.max(100,e.clientX-t.x),t.height=Math.max(100,e.clientY-t.y))}function H(){N.value=null,C.value=[],window.removeEventListener("mousemove",V),window.removeEventListener("mouseup",H)}function be(e,t,n){const l=d.value.getBoundingClientRect(),c=a.find(r=>r.id===e);if(!c)return;const i=c.y+36+t*24;f.active=!0,f.from={table:e,col:t},f.sx=c.x+c.width,f.sy=i,ne(n.clientX-l.left,n.clientY-l.top);const o=r=>ne(r.clientX-l.left,r.clientY-l.top),s=r=>he(r,o,s);window.addEventListener("pointermove",o),window.addEventListener("pointerup",s)}function ne(e,t){f.path=W(f.sx,f.sy,e,t)}function he(e,t,n){if(window.removeEventListener("pointermove",t),window.removeEventListener("pointerup",n),!f.active)return;const l=d.value.getBoundingClientRect(),c=e.clientX-l.left,i=e.clientY-l.top;let o=null;for(const s of a)if(c>=s.x&&c<=s.x+s.width&&i>=s.y&&i<=s.y+200){const r=Math.floor((i-(s.y+36))/24);if(r>=0&&r<s.columns.length){o={table:s.id,col:r};break}}if(o){const s={id:$++,from:{table:f.from.table,col:f.from.col,colName:a.find(p=>p.id===f.from.table).columns[f.from.col].name},to:{table:o.table,col:o.col,colName:a.find(p=>p.id===o.table).columns[o.col].name},path:""};u.some(p=>p.from.table===f.from.table&&p.from.col===f.from.col&&p.to.table===o.table&&p.to.col===o.col)||(u.push(s),A())}f.active=!1,f.path=""}function ve(e){const t=JSON.parse(JSON.stringify(e));t.id=g++,t.dbid="",t.x+=20,t.y+=20,t.name=e.name+"_copy",a.push(t),A()}async function ye(e){if(!confirm("Are you sure to delete Table?"))return;const t=a.findIndex(l=>l.id===e),n=a.find(l=>l.id===e);n.dbid&&await L.purgeTable(n.dbid),t>=0&&a.splice(t,1);for(let l=u.length-1;l>=0;l--)(u[l].from.table===e||u[l].to.table===e)&&u.splice(l,1)}async function we(e){if(!confirm("Are you sure to delete Area ?"))return;const t=m.findIndex(n=>n.id===e);t>=0&&m.splice(t,1)}function xe(){b.value&&b.value.columns.push({name:"new_col",type:"varchar"})}function ge(e){b.value&&b.value.columns.splice(e,1)}function Ce(e){const t=u.findIndex(n=>n.id===e);t>=0&&u.splice(t,1)}function Ae(e){if(b.value)try{const t=JSON.parse(e);b.value.name=t.name||b.value.name,b.value.x=Number(t.x??b.value.x),b.value.y=Number(t.y??b.value.y),b.value.width=Number(t.width??b.value.width),Array.isArray(t.columns)&&(b.value.columns=t.columns),A(),alert("Applied to selected table")}catch(t){console.error(t),alert("Invalid JSON")}}function Se(e){navigator.clipboard.writeText(e).then(()=>alert("Copied"))}async function Ne(){confirm("Reset design?")&&await ae()}function oe(){const e=new Set(u.map(n=>`${n.from.table}_${n.from.col}-${n.to.table}_${n.to.col}`)),t=a.reduce((n,l)=>{const c=l.columns.map((i,o)=>i.type==="auto"?o:null).filter(i=>i!==null);return n[l.id]=c,n},{});for(let n=0;n<a.length;n++){const l=a[n];for(let c=0;c<a.length;c++){if(n===c)continue;const i=a[c];l.columns.forEach((o,s)=>{if(o.name.toLowerCase()===i.name.toLowerCase()+"id"){if(!t[i.id]||t[i.id].length===0)return;const r=t[i.id][0],p=`${l.id}_${s}-${i.id}_${r}`,Y=`${i.id}_${r}-${l.id}_${s}`;if(e.has(p)||e.has(Y))return;u.push({id:$++,from:{table:l.id,col:s,colName:o.name},to:{table:i.id,col:r,colName:i.columns[r].name},path:""}),e.add(p)}})}}A(),y.add({title:"Auto Relations",description:"Relations generated intelligently",color:"success"})}function Te(e){if(!e)return;const n=e.trim().split(/\s+/)[0]||"table_"+g;if(a.some(o=>o.name.toLowerCase()===n.toLowerCase())){y.add({title:"Duplicate Table",description:`Table with name "${n}" already exists!`,color:"warning"});return}let l=e.toLowerCase().split("with")[1]||"";l=l.replace(/and/g,",");const c=l.split(",").map(o=>o.trim()).filter(o=>o),i={id:g++,dbid:"",name:n,x:40+a.length%4*340,y:40+Math.floor(a.length/4)*200,width:240,columns:c.map(o=>{let s="text";return o.includes("id")&&o.replace(/_/g,"").includes(n.toLowerCase())?s="auto":o.includes("id")?s="int":o.includes("date")||o.endsWith("at")?s="timestamp":o.startsWith("is")||o.startsWith("has")||o.startsWith("recordstatus")?s="boolean":(o.includes("amount")||o.includes("price")||o.includes("total"))&&(s="number"),{name:o,type:s}}),ispublished:!1,comment:""};a.push(i),q(i.id),A(),oe(),y.add({title:"AI Table Generated",description:`Table "${n}" created!`,color:"success"})}function _e(e){if(!e)return;const t=e.split(/[\.\n]/).map(n=>n.trim()).filter(Boolean);for(const n of t){const l=n.toLowerCase();if(l.startsWith("create table")){const c=n.replace(/create table/i,"").trim();Te(c);continue}if(l.includes("add column")){const c=/add column (\w+)(?: (above|below) (\w+))?(?: (?:to|in) (\w+))?/i.exec(n);if(c){const[,i,o,s,r]=c;let p=null;if(r){if(p=a.find(K=>K.name.toLowerCase()===r.toLowerCase()),!p){y.add({title:"Table Not Found",description:`Table "${r}" not found`,color:"warning"});continue}}else if(p=b.value||a[a.length-1],!p){y.add({title:"No Table Selected",description:`Cannot add column "${i}"`,color:"warning"});continue}const Y=s?p.columns.findIndex(K=>K.name.toLowerCase()===s.toLowerCase()):-1;let B="text";i.includes("id")&&i.replace(/_/g,"").includes(p.name.toLowerCase())?B="auto":i.includes("id")?B="int":i.includes("date")||i.endsWith("at")?B="timestamp":i.startsWith("is")||i.startsWith("has")||i.startsWith("recordstatus")?B="boolean":(i.includes("amount")||i.includes("price")||i.includes("total"))&&(B="number");const Ie=Y>=0?o==="above"?Y:Y+1:p.columns.length;p.columns.splice(Ie,0,{name:i,type:B})}continue}if(l.includes("remove column")||l.includes("delete column")){const c=/(?:remove|delete) column (\w+)/i.exec(n);if(c){const[,i]=c;let o=b.value;if(!o){y.add({title:"No Table Selected",description:`Cannot remove column "${i}"`,color:"warning"});continue}const s=o.columns.findIndex(r=>r.name.toLowerCase()===i.toLowerCase());s>=0&&o.columns.splice(s,1)}continue}if(l.includes("delete table")){const i=/delete table (\w+)?/i.exec(n)?.[1];if(i){const o=a.findIndex(s=>s.name.toLowerCase()===i.toLowerCase());o>=0&&a.splice(o,1)}else if(b.value){const o=a.findIndex(s=>s.id===b.value.id);o>=0&&a.splice(o,1)}else y.add({title:"No Table Selected",description:"Cannot delete table",color:"warning"});continue}if(l.includes("delete area")){const i=/delete area (\w+)?/i.exec(n)?.[1];if(i){const o=m.findIndex(s=>s.name.toLowerCase()===i.toLowerCase());o>=0&&m.splice(o,1)}else if(N.value){const o=m.findIndex(s=>s.id===N.value.id);o>=0&&m.splice(o,1)}else y.add({title:"No Area Selected",description:"Cannot delete area",color:"warning"});continue}console.warn("Unknown instruction:",n)}A(),y.add({title:"AI Natural Instructions Executed",description:"All recognized actions applied.",color:"success"})}function je(e){console.log("AI Suggest Columns",e)}function ke(){d.value!==null&&se(d.value,{cacheBust:!0,filter:e=>e.tagName!=="i"}).then(e=>{const t=document.createElement("a");t.download="database-design.png",t.href=e,t.click()}).catch(e=>{console.error(e)})}function $e(e){const t=document.createElement("div");t.style.position="absolute",t.style.left="0",t.style.top="0",t.style.background="white",t.style.padding="10px";const n=document.querySelector(`[data-area-id="${e.id}"]`);if(!n)return;const l=n.cloneNode(!0);l.style.position="relative",l.style.left="0",l.style.top="0",t.appendChild(l),a.forEach(c=>{if(c.x>=e.x&&c.x<=e.x+e.width&&c.y>=e.y&&c.y<=e.y+e.height){const i=document.querySelector(`[data-table-id="${c.id}"]`);if(i){const o=i.cloneNode(!0);o.style.position="absolute",o.style.left=c.x-e.x+"px",o.style.top=c.y-e.y+"px",t.appendChild(o)}}}),document.body.appendChild(t),se(t,{cacheBust:!0}).then(c=>{const i=document.createElement("a");i.download=`${e.name}.png`,i.href=c,i.click(),document.body.removeChild(t)})}async function Le(){if(!a.length)return alert("No tables to save");try{for(const e of Xe(a)){const t={table:e,relations:u.filter(o=>o.from.table===e.id||o.to.table===e.id).map(o=>({id:o.id,from:{...o.from,table:a.find(s=>s.id===o.from.table)?.dbid},to:{...o.to,table:a.find(s=>s.id===o.to.table)?.dbid}})),areas:m},n={dbobjectid:e.dbid?String(e.dbid):"",objectname:e.name,dbobjecttypeid:"1",objectcontent:JSON.stringify(t),objectversion:"1",ispublished:e.ispublished?1:0,comment:e.comment||""},l=await L.saveTable(n),c=l?.data?.data??l,i=c?.dbobjectid??c?.dbobjectid??null;if(i){const o=a.find(s=>s.id===e.id);o&&(o.dbid=i)}}y.add({title:"Success",description:"Runtime schema saved successfully",color:"success"})}catch(e){console.error(e),y.add({title:"Error",description:String(e),color:"error"})}}async function ae(){a.splice(0,a.length),u.splice(0,u.length),m.splice(0,m.length),g=1,_=1,$=1,O.value=null,await L.fetchAll();const e=new Set,t=[],n={};(L.dbobjects||[]).forEach(l=>{const c=l?.dbobjectid?String(l.dbobjectid):l?.objectname??"";c&&(e.has(c)||(e.add(c),t.push(l)))}),t.forEach((l,c)=>{const i=Ee(l,c);n[l.dbobjectid]=i.id,a.push(i)}),g=Math.max(...a.map(l=>l.id),0)+1,Re(t,n),A()}function Ee(e,t){let n=0,l=0,c=120,i=[];if(e.objectcontent)try{const s=JSON.parse(e.objectcontent);s?.table?.columns&&Array.isArray(s.table.columns)&&(i=s.table.columns.map(r=>({name:r.name||"col",type:r.type||"text",allownull:r.allownull??!1,default:r.default??""}))),n=s?.table?.x??40+t%4*340,l=s?.table?.y??40+Math.floor(t/4)*200,c=s?.table?.width??240,s.areas&&s.areas.length>0&&s.areas.forEach(r=>{m.find(p=>p.id==r.id)==null&&De(r)})}catch(s){console.warn(`Invalid objectcontent JSON for ${e.objectname}`,s)}return{id:g++,dbid:e.dbobjectid??"",name:e.objectname||`table_${t+1}`,x:n,y:l,width:c,columns:i,ispublished:e.ispublished==1,comment:e.comment??""}}function De(e){const t={id:e.id,name:e.name,x:e.x,y:e.y,width:e.width,height:e.height,color:e.color,type:"area"};m.push(t),_=e.id}function Re(e,t){u.splice(0,u.length);const n=new Set;e.forEach(l=>{if(!l.objectcontent)return;let c=null;try{c=JSON.parse(l.objectcontent)}catch{return}Array.isArray(c.relations)&&c.relations.forEach(i=>{const o=t[i.from.table],s=t[i.to.table];if(!o||!s)return;const r=`${o}|${i.from.col}|${s}|${i.to.col}`;n.has(r)||(n.add(r),u.push({id:$++,from:{table:o,col:i.from.col,colName:i.from.colName},to:{table:s,col:i.to.col,colName:i.to.colName},path:""}))})}),A()}return Fe(async()=>{await ae()}),(e,t)=>(j(),P("div",He,[t[5]||(t[5]=S("header",{class:"flex items-center justify-between p-4 border-b bg-white sticky"},[S("div",{class:"flex items-center gap-3"},[S("h1",{class:"text-xl font-semibold"},"Database Designer")])],-1)),S("div",Ke,[S("div",Ue,[ze(h(k),{tables:h(a),areas:h(m),selectedTable:b.value,relations:h(u),jsonPreview:Z.value,aiDescription:te.value,onAddTable:re,onAddArea:fe,onSave:Le,onReset:Ne,onAiSuggest:oe,onSelectTable:q,onZoomIn:h(D),onZoomOut:h(F),onResetZoom:h(z),onExportPng:ke,"onUpdate:jsonPreview":t[0]||(t[0]=n=>Z.value=n),"onUpdate:aiDescription":t[1]||(t[1]=n=>te.value=n),onAiParse:_e,onRemoveColumn:ge,onAddColumn:xe,onAiSuggestTypes:je,onApplyJson:Ae,onCopyJson:Se,onRemoveRelation:Ce},null,8,["tables","areas","selectedTable","relations","jsonPreview","aiDescription","onZoomIn","onZoomOut","onResetZoom"])]),S("div",Ge,[S("div",{class:"relative p-4 min-w-[2000px] min-h-[2000px]",onDragover:t[2]||(t[2]=Je(()=>{},["prevent"])),onDrop:ue,ref_key:"canvasRef",ref:d,id:"drawflow",style:Be({transform:`scale(${h(R)})`,transformOrigin:"0 0",width:h(R)<1?`${100/h(R)}%`:"100%",height:h(R)<1?`${100/h(R)}%`:"100%"})},[(j(!0),P(G,null,Q(h(m),n=>(j(),le(h(v),{key:n.id,area:n,onStartDrag:me,onStartResize:pe,onExport:$e,onDelete:we},null,8,["area"]))),128)),(j(),P("svg",Qe,[t[3]||(t[3]=S("defs",null,[S("marker",{id:"arrow",markerWidth:"10",markerHeight:"10",refX:"10",refY:"5",orient:"auto"},[S("path",{d:"M0,0 L10,5 L0,10 z",fill:"black"})])],-1)),(j(!0),P(G,null,Q(h(u),n=>(j(),P("g",{key:n.id},[S("path",{d:n.path,stroke:"black","stroke-width":"2",fill:"none","marker-end":"url(#arrow)"},null,8,et)]))),128)),h(f).active?(j(),P("path",{key:0,d:h(f).path,stroke:"gray","stroke-width":"2",fill:"none","stroke-dasharray":"6 4"},null,8,tt)):Ye("",!0)])),(j(!0),P(G,null,Q(h(a),n=>(j(),le(h(x),{key:n.id,table:n,onDragstart:de,onSelect:q,onDuplicate:ve,onDelete:ye,onStartLink:be},null,8,["table"]))),128)),t[4]||(t[4]=S("div",{class:"absolute left-4 bottom-4"},null,-1))],36)])])]))}});export{ut as default};
