import{q as oe,k as C,e as J,i as ne,l as G,B as H,aC as ae,E as re,c as p,o as u,h as j,a as s,t as D,n as K,aN as se,F as z,r as A,m as I,v as B,z as X,g as O,j as le,_ as de,I as q,b as W,C as ce,G as ie}from"#entry";import{u as Y}from"./bU7HDp6y.js";import{t as ue}from"./CCayPtYg.js";import{u as pe}from"./BoNypvcG.js";import"./F2cpyflp.js";const M=oe("workflow",()=>{const N=C(null),m=C([]),c=C([]),f=C([]),h=C([]),b=C([]),n=C(null),i=C([]),g=C(!1),w=Y();async function P(d){g.value=!0;try{const e=new FormData;e.append("flowname","getworkflow"),e.append("menu","admin"),e.append("search","true"),e.append("workflowid",d),e.append("wfname",d);const o=(await w.post("/admin/execute-flow",e))?.data?.data??{},v=o?.flow;if(v&&typeof v=="string")try{o.flow=JSON.parse(v)}catch(te){console.error("Failed parsing flow string",te),o.flow=null}N.value=o;const x=new FormData;x.append("flowname","searchcombocomponentcategory"),x.append("menu","admin"),x.append("search","true");const y=await w.post("/admin/execute-flow",x);m.value=y.data?.data??[];const $=new FormData;$.append("flowname","searchcombocomponent"),$.append("menu","admin"),$.append("search","true");const k=await w.post("/admin/execute-flow",$);c.value=k.data?.data??[];const U=new FormData;U.append("flowname","searchwfparameter"),U.append("menu","admin"),U.append("search","true"),U.append("wfname",d);const Q=await w.post("/admin/execute-flow",U);i.value=Q.data?.data??[];const L=new FormData;L.append("flowname","searchcomponentdetails"),L.append("menu","admin"),L.append("search","true");const Z=await w.post("/admin/execute-flow",L);h.value=Z.data?.data??[];const R=new FormData;R.append("flowname","searchwfdetailbywfname"),R.append("menu","admin"),R.append("search","true"),R.append("wfname",d);const ee=await w.post("/admin/execute-flow",R);f.value=ee.data?.data??[]}finally{g.value=!1}}function T(d){return c.value.find(e=>e.code===d||e.componentname===d||e.name===d)}async function E(d,e){const t=h.value.filter(y=>y.componentname===d),o=f.value.filter(y=>y.componentname===d&&Number(y.nodeid)===Number(e)),v=new Map;o.forEach(y=>{v.set(y.componentdetailid||y.inputname,y)});const x=t.map(y=>{const $=y.componentdetailid||y.inputname,k=v.get($);return{...y,workflowdetailid:k?.workflowdetailid??0,workflowid:k?.workflowid??0,componentvalue:k?.componentvalue??""}});return b.value=x,x}function F(d,e){return h.value.find(t=>t.componentname===d&&t.inputname===e)||null}function r(d,e,t){return f.value.find(o=>o.componentid===d&&o.componentdetailid===e&&Number(o.nodeid)===Number(t))?.workflowdetailid??""}async function _(d){const e=d?.drawflow?.Home?.data??{};for(const t of Object.values(e)){const o=t?.name,v=t?.data??{};for(const x of Object.keys(v)){const y=F(o,x);if(!y){console.warn("Meta not found:",o,x);continue}const $=r(y.componentid,y.componentdetailid,t.id),k=new FormData;k.append("flowname","modifworkflowdetail"),k.append("menu","admin"),k.append("search","false"),k.append("workflowid",N.value?.workflowid??""),k.append("componentid",y.componentid),k.append("componentdetailid",y.componentdetailid),k.append("workflowdetailid",$||""),k.append("componentvalue",v[x]),k.append("nodeid",t.id),await w.post("/admin/execute-flow",k)}}}async function a(){for(let d=0;d<i.value.length;d++){const e=i.value[d],t=new FormData;t.append("flowname","modifwfparameter"),t.append("menu","admin"),t.append("search","false"),t.append("workflowid",N.value?.workflowid??""),t.append("wfparameterid",e.wfparameterid??""),t.append("parametername",e.parametername??""),t.append("parametervalue",e.parametervalue??""),t.append("parametertype",e.parametertype??""),await w.post("/admin/execute-flow",t)}}async function l(d){g.value=!0;try{const e=new FormData;e.append("flowname","saveflow"),e.append("menu","admin"),e.append("search","false"),e.append("workflowid",N.value?.workflowid??""),e.append("flow",JSON.stringify(d));const t=await w.post("/admin/execute-flow",e);return await _(d),await a(),await P(N.value?.wfname),t}finally{g.value=!1}}function S(d){n.value=d}function V(d){if(!n.value)return;const e=window.editor;if(!e)return;const t=e.drawflow?.drawflow?.Home?.data;if(!t)return;const o=Object.keys(t).find(v=>Number(t[v].id)===Number(n.value.id));o&&(t[o].data={...t[o].data||{},...d},e.drawflow.drawflow.Home.data=t,l(e.export()))}return{workflow:N,categories:m,components:c,componentProperties:b,selectedNode:n,parameters:i,loading:g,loadWorkflow:P,findComponentByName:T,loadComponentProperties:E,saveFlow:l,setSelectedNode:S,updateSelectedNodeData:V}}),me={class:"relative h-full"},fe={key:0,id:"test-result-overlay",class:"absolute top-6 left-6 p-4 bg-white shadow-xl rounded border z-50 max-w-md"},we={class:"text-sm whitespace-pre-wrap"},ve={class:"text-sm whitespace-pre-wrap"},be=J({__name:"Designer",setup(N){const{t:m}=ne(),c=M(),f=pe(),h=C(""),b=C("");let n=null,i=null;function g(e){const{$drawflow:t}=se();if(!t)return console.error("❌ Drawflow plugin not available"),null;const o=new t(e);return o.reroute=!0,o.reroute_fix_curvature=!0,o.force_first_input=!1,o.start(),o.on("nodeCreated",()=>w()),o.on("nodeRemoved",()=>w()),o.on("connectionCreated",()=>w()),o.on("connectionRemoved",()=>w()),o.on("nodeSelected",async v=>{const x=v.replace("node-",""),y=o.drawflow.drawflow?.Home?.data?.[x];y&&(await c.loadComponentProperties(y.name,x.toString()),c.setSelectedNode(y))}),o}function w(){i&&clearTimeout(i),i=setTimeout(()=>{try{c.saveFlow(n.export())}catch(e){console.error("❌ saveFlow error",e)}},500)}async function P(){try{const e=await c.saveFlow(n.export());e.code==200&&f.add({title:m("TITLE UPDATE"),description:m(e.message.replaceAll("_"," "))})}catch(e){console.error("❌ saveFlow error",e)}}G(async()=>{const e=document.getElementById("drawflow");if(!e){console.error("❌ drawflow element not found");return}n=g(e),window.editor=n;const t=c.workflow?.flow;if(t&&n)try{n.import(t)}catch(o){console.error("❌ ERROR IMPORT DRAWFLOW",o)}}),H(()=>c.workflow,e=>{if(!(!e||!e.flow||!n))try{const t=typeof e.flow=="string"?JSON.parse(e.flow):e.flow;n.import(t.drawflow?t:t.flow)}catch(t){console.error("❌ Failed to import workflow",t)}},{immediate:!0}),ae(()=>{try{n?.destroy()}catch(e){console.error(e)}});function T(){n?.zoom_in()}function E(){n?.zoom_out()}function F(){n?.zoom_reset()}function r(e){if(e.preventDefault(),!n)return;const t=e.dataTransfer?.getData("node");if(!t){console.warn("⚠️ drop: no data received");return}const o=JSON.parse(t),v=document.getElementById("drawflow").getBoundingClientRect(),x=e.clientX-v.left,y=e.clientY-v.top;n.addNode(o.componentname??o.name??o.code,o.input??o.inputs??1,o.output??o.outputs??1,x,y,o.componentname??o.name,{},`<div class='title-box'>${o.componenttitle??o.label??o.name}</div>`),w()}function _(e){e.querySelectorAll("*").forEach(o=>{const v=window.getComputedStyle(o);v.color.includes("oklch")&&(o.style.color="#222"),v.backgroundColor.includes("oklch")&&(o.style.backgroundColor="#fff"),v.borderColor.includes("oklch")&&(o.style.borderColor="#ccc")})}async function a(){const e=document.getElementById("drawflow");if(!e)return;_(e);const t=await ue(el,{cacheBust:!0,pixelRatio:2}),o=document.createElement("a");o.download="workflow.png",o.href=t,o.click()}const l=re(),S=Y();function V(e){const t={};for(const[o,v]of e.entries())t[o]=v instanceof File?v.name:v;return t}async function d(){try{const e=new FormData;e.append("flowname",l.params.slug),e.append("menu","admin"),e.append("search","true");for(let o=0;o<c.parameters.length;o++){const v=c.parameters[o];e.append(v.parametername,v.parametervalue)}const t=await S.post("admin/execute-flow",e);b.value=JSON.stringify(V(e),null,2),t?.code==200?h.value=JSON.stringify(t.data??t.message,null,2):h.value=`Error: ${t.message}`}catch(e){h.value=`Exception: ${e}`}}return(e,t)=>(u(),p("div",me,[h.value?(u(),p("div",fe,[t[1]||(t[1]=s("h3",{class:"font-bold text-lg"},"Payload (Form Data)",-1)),s("pre",we,D(b.value),1),t[2]||(t[2]=s("h3",{class:"font-bold text-lg"},"Test Result",-1)),s("pre",ve,D(h.value),1)])):j("",!0),s("div",{id:"drawflow",class:"absolute inset-0",onDrop:r,onDragover:t[0]||(t[0]=K(()=>{},["prevent"]))},null,32),s("div",{class:"absolute right-6 top-6 flex flex-row gap-2 z-50"},[s("button",{onClick:E,class:"p-2 rounded shadow bg-white text-black"},"-"),s("button",{onClick:F,class:"p-2 rounded shadow bg-white text-black"},"Reset"),s("button",{onClick:T,class:"p-2 rounded shadow bg-white text-black"},"+"),s("button",{onClick:P,class:"p-2 rounded shadow bg-white text-black"},"Save"),s("button",{onClick:a,class:"p-2 rounded shadow bg-white text-black"},"Export PNG"),s("button",{onClick:d,class:"p-2 rounded shadow bg-white text-black"},"Test Flow")])]))}}),ye=Object.assign(be,{__name:"Designer"}),he=["onUpdate:modelValue"],ge=["onUpdate:modelValue"],_e=["onUpdate:modelValue","onChange"],xe=["onClick"],ke=J({__name:"FlowParameter",setup(N){const m=M();function c(){m.parameters.push({wfparameterid:"",parametername:"",parametervalue:"",parametertype:"string"})}function f(b){m.parameters=m.parameters.filter(n=>n.wfparameterid!==b)}function h(b){if(b.type==="number"&&(b.value=Number(b.value)||0),b.type==="boolean"&&(b.value=b.value==="true"),b.type==="json")try{b.value=JSON.stringify(JSON.parse(b.value),null,2)}catch{b.value="{}"}}return(b,n)=>(u(),p("div",null,[n[1]||(n[1]=s("h3",{class:"font-semibold mb-3"},"Flow Parameters",-1)),s("button",{onClick:c,class:"px-3 py-1 bg-blue-500 text-white rounded mb-3"},"Add Parameter"),(u(!0),p(z,null,A(O(m).parameters,(i,g)=>(u(),p("div",{key:i.wfparameterid??g,class:"flex items-center gap-2 mb-2"},[I(s("input",{"onUpdate:modelValue":w=>i.parametername=w,placeholder:"param name (e.g. search)",class:"border p-2 rounded flex-1"},null,8,he),[[B,i.parametername]]),I(s("input",{"onUpdate:modelValue":w=>i.parametervalue=w,placeholder:"value",class:"border p-2 rounded flex-1"},null,8,ge),[[B,i.parametervalue]]),I(s("select",{"onUpdate:modelValue":w=>i.parametertype=w,class:"border p-2 rounded w-32",onChange:w=>h(i)},[...n[0]||(n[0]=[s("option",{value:"string"},"string",-1),s("option",{value:"number"},"number",-1),s("option",{value:"boolean"},"boolean",-1),s("option",{value:"json"},"json",-1)])],40,_e),[[X,i.parametertype]]),s("button",{onClick:w=>f(i.wfparameterid),class:"text-red-500 font-bold hover:text-red-700"},"✕",8,xe)]))),128))]))}}),Ne=Object.assign(ke,{__name:"FlowParameter"}),Ce={class:"space-y-4"},Fe={class:"flex items-center justify-between"},$e={class:"text-lg font-semibold"},De={key:0,class:"text-sm text-gray-500"},Se={class:"block text-sm font-medium text-gray-700"},Oe=["onUpdate:modelValue","placeholder","onInput"],Ie=["onUpdate:modelValue","placeholder","onInput"],Pe=["onUpdate:modelValue","onChange"],Te={key:0,value:""},je=["value"],Ee=["onUpdate:modelValue","onInput"],Ve={key:4,class:"text-xs text-gray-400"},Ue=J({__name:"PropertyForm",props:{componentName:{type:String,required:!1},nodeId:{type:[String,Number],required:!1}},setup(N){const m=N,c=M(),f=le({}),h=C([]);function b(r,_=500){let a=null;return function(...l){clearTimeout(a),a=setTimeout(()=>r.apply(this,l),_)}}function n(r){return(r.inputtype??"").toLowerCase()==="textbox"}function i(r){return(r.inputtype??"").toLowerCase()==="textarea"}function g(r){return(r.inputtype??"").toLowerCase()==="combobox"||(r.inputtype??"").toLowerCase()==="select"}function w(r){const _=r.datasource;return!!(_&&_.length)}function P(r){return r?r.datasourcetype&&r.datasourcetype.toLowerCase()==="list"&&r.datasource?r.datasource.split(",").map(_=>_.trim()):Array.isArray(r.datasource)?r.datasource:[]:[]}function T(){h.value.sort((a,l)=>(Number(a.order)||0)-(Number(l.order)||0));let r={};const _=window.editor;if(_){const a=_.drawflow?.drawflow?.Home?.data,l=c.selectedNode;if(a&&l){const S=Object.keys(a).find(V=>Number(a[V].id)===Number(l.id));S&&a[S]?.data&&(r=a[S].data)}}h.value.forEach(a=>{const l=a.inputname;r&&Object.prototype.hasOwnProperty.call(r,l)?f[l]=r[l]:f[l]=a.componentvalue??""})}const E=b(()=>{const r={};h.value.forEach(_=>{r[_.inputname]=f[_.inputname]}),c.updateSelectedNodeData(r)},500);function F(r){E()}return H([()=>m.componentName,()=>m.nodeId],async([r,_])=>{if(!r){h.value=[],Object.keys(f).forEach(l=>delete f[l]);return}const a=await c.loadComponentProperties(r,_);h.value=a,T()},{immediate:!0}),H(()=>c.selectedNode,r=>{r&&T()},{deep:!0}),(r,_)=>(u(),p("div",Ce,[s("div",Fe,[s("h3",$e,D(N.componentName??"Properties"),1)]),h.value.length===0?(u(),p("div",De,"No properties available for this component.")):(u(),p("form",{key:1,class:"space-y-3",onSubmit:_[0]||(_[0]=K(()=>{},["prevent"]))},[(u(!0),p(z,null,A(h.value,a=>(u(),p("div",{key:a.componentdetailid,class:"space-y-1"},[s("label",Se,D(a.lable??a.inputname),1),n(a)?I((u(),p("input",{key:0,"onUpdate:modelValue":l=>f[a.inputname]=l,placeholder:a.inputdesc||"",class:"w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300",onInput:l=>F()},null,40,Oe)),[[B,f[a.inputname]]]):i(a)?I((u(),p("textarea",{key:1,"onUpdate:modelValue":l=>f[a.inputname]=l,placeholder:a.inputdesc||"",rows:"4",class:"w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300",onInput:l=>F()},null,40,Ie)),[[B,f[a.inputname]]]):g(a)?I((u(),p("select",{key:2,"onUpdate:modelValue":l=>f[a.inputname]=l,class:"w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300",onChange:l=>F()},[w(a)?j("",!0):(u(),p("option",Te,"-- select --")),(u(!0),p(z,null,A(P(a),l=>(u(),p("option",{key:l,value:l},D(l),9,je))),128))],40,Pe)),[[X,f[a.inputname]]]):I((u(),p("input",{key:3,"onUpdate:modelValue":l=>f[a.inputname]=l,class:"w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300",onInput:l=>F()},null,40,Ee)),[[B,f[a.inputname]]]),a.inputdesc?(u(),p("p",Ve,D(a.inputdesc),1)):j("",!0)]))),128))],32))]))}}),Re=Object.assign(de(Ue,[["__scopeId","data-v-29511cde"]]),{__name:"PropertyForm"}),Be={class:"h-full flex flex-col bg-white text-gray-900 shadow-sm border-l"},ze={class:"flex border-b"},Ae={class:"flex-1 overflow-auto p-3"},Je={key:0},Me={class:"font-semibold text-sm text-gray-700 mb-2"},Le=["onDragstart"],qe={class:"text-sm"},He={key:1},We={key:2},Ge={key:1,class:"text-gray-500"},Ke=J({__name:"Sidebar",setup(N){const m=C("toolbox"),c=M();function f(b){return c.components.filter(n=>n?n.categoryname===b.categoryname:!1)}function h(b,n){b.dataTransfer?.setData("node",JSON.stringify(n))}return(b,n)=>(u(),p("div",Be,[s("div",ze,[s("button",{class:q(["px-4 py-2",m.value==="toolbox"?"bg-blue-500 text-white":""]),onClick:n[0]||(n[0]=i=>m.value="toolbox")}," Toolbox ",2),s("button",{class:q(["px-4 py-2",m.value==="parameter"?"bg-blue-500 text-white":""]),onClick:n[1]||(n[1]=i=>m.value="parameter")}," Flow Parameter ",2),s("button",{class:q(["px-4 py-2",m.value==="property"?"bg-blue-500 text-white":""]),onClick:n[2]||(n[2]=i=>m.value="property")}," Property ",2)]),s("div",Ae,[m.value==="toolbox"?(u(),p("div",Je,[(u(!0),p(z,null,A(O(c).categories,i=>(u(),p("div",{key:i.id,class:"mb-4"},[s("div",Me,D(i.categoryname??i.label??i.name),1),s("div",null,[(u(!0),p(z,null,A(f(i),g=>(u(),p("div",{key:g.componentname??g.code??g.name,draggable:"true",onDragstart:w=>h(w,g),class:"p-2 border rounded mb-2 cursor-grab flex items-center gap-2"},[s("i",{class:q(g.componentclass??g.icon)},null,2),s("span",qe,D(g.componenttitle??g.label??g.name),1)],40,Le))),128))])]))),128))])):j("",!0),m.value==="parameter"?(u(),p("div",He,[W(Ne)])):j("",!0),m.value==="property"?(u(),p("div",We,[O(c).selectedNode?(u(),ce(Re,{key:0,componentName:O(c).selectedNode.name,nodeId:O(c).selectedNode.nodeid??O(c).selectedNode.id??O(c).selectedNode.data?.nodeid},null,8,["componentName","nodeId"])):(u(),p("div",Ge,"Select a node to edit properties"))])):j("",!0)])]))}}),Xe=Object.assign(Ke,{__name:"Sidebar"}),Ye={class:"h-screen flex overflow-hidden"},Qe={class:"flex-1 relative bg-gray-100"},Ze={class:"w-80 bg-white border-l"},rt=J({__name:"[...slug]",setup(N){const m=ie(),c=M();return G(async()=>{const f=m.params.slug??m.params.id??m.query.id;f&&await c.loadWorkflow(f)}),(f,h)=>(u(),p("div",Ye,[s("div",Qe,[W(ye)]),s("div",Ze,[W(Xe)])]))}});export{rt as default};
